<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asignar Batches - Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #059669 0%, #34D399 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    /* Men√∫ hamburguesa - Versi√≥n overlay elegante */
    .menu-toggle {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 1500;
      background: rgba(255, 255, 255, 0.25);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      border-radius: 20px;
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(20px);
      font-size: 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    .menu-toggle:hover {
      background: rgba(255, 255, 255, 0.35);
      transform: scale(1.05) rotate(5deg);
      box-shadow: 0 12px 40px rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    .menu-toggle.active {
      transform: scale(0.95) rotate(90deg);
      background: rgba(255, 255, 255, 0.4);
    }
    
    /* Men√∫ lateral elegante overlay */
    .side-menu {
      position: fixed;
      top: 0;
      right: -400px;
      width: 350px;
      height: 100vh;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
      backdrop-filter: blur(25px);
      z-index: 1400;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 0;
      overflow: hidden;
      box-shadow: -10px 0 50px rgba(0, 0, 0, 0.2);
      border-left: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .side-menu.open {
      right: 0;
    }
    
    .menu-header {
      padding: 2rem 1.5rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
    }
    
    .menu-header h5 {
      color: white;
      margin: 0;
      font-weight: 600;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .menu-items {
      padding: 1rem 0;
    }
    
    .menu-item {
      display: flex;
      align-items: center;
      padding: 1rem 1.5rem;
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 0;
      position: relative;
      font-weight: 500;
      backdrop-filter: blur(5px);
    }
    
    .menu-item:before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
      transition: width 0.3s ease;
      z-index: -1;
    }
    
    .menu-item:hover:before {
      width: 100%;
    }
    
    .menu-item:hover {
      color: white;
      transform: translateX(10px);
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .menu-item i {
      margin-right: 1rem;
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
    }
    
    /* Overlay para cerrar men√∫ */
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.3);
      z-index: 1300;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .menu-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    /* T√≠tulo principal */
    .dashboard-title {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.1) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2rem 3rem;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-title h1 {
      color: white;
      font-size: 3rem;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      letter-spacing: 2px;
    }
    
    .dashboard-title p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.2rem;
      margin: 0.5rem 0 0 0;
      font-weight: 300;
    }
    
    /* Asegurar que el contenido principal tenga el z-index correcto */
    .main-content {
      position: relative;
      z-index: 1;
    }
    
    .card { 
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      transition: transform 0.2s ease;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(16, 185, 129, 0.2);
    }
    
    .navbar {
      background: linear-gradient(135deg, #059669 0%, #34D399 100%) !important;
      backdrop-filter: blur(10px);
      border: none;
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    .btn-primary { 
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      border: none;
      border-radius: 25px;
      padding: 10px 25px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
    }
    
    .btn-primary:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
      background: linear-gradient(135deg, #059669 0%, #10B981 100%);
    }
    
    .btn-outline-light {
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      border-radius: 20px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-outline-light:hover {
      background: rgba(255,255,255,0.2);
      border-color: white;
      color: white;
      transform: translateY(-1px);
    }
    
    .btn-outline-danger {
      border: 2px solid #EF4444;
      color: #EF4444;
      border-radius: 20px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-outline-danger:hover {
      background: #EF4444;
      border-color: #EF4444;
      color: white;
      transform: translateY(-1px);
    }

    /* Estilos para las tarjetas de estad√≠sticas */
    .card-title {
      background: linear-gradient(135deg, #10B981, #34D399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 600;
    }

    /* Estilos para Drag & Drop */
    .drop-zone {
      transition: all 0.3s ease;
      border: 2px dashed transparent;
    }

    .drop-zone.drag-over {
      border-color: #10B981;
      background-color: rgba(16, 185, 129, 0.1);
      transform: scale(1.02);
    }

    .batch-item {
      cursor: move;
      transition: all 0.3s ease;
      user-select: none;
      margin-bottom: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 10px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .batch-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      border-color: #007bff;
    }

    .batch-item.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
      z-index: 1000;
    }

    .batch-item.no-assigned {
      border-left: 4px solid #ffc107;
    }

    .batch-item.assigned {
      border-left: 4px solid #28a745;
    }

    .pending-batch {
      border-left: 4px solid #17a2b8 !important;
      background-color: rgba(23, 162, 184, 0.05);
    }

    .pending-batch:hover {
      background-color: rgba(23, 162, 184, 0.1);
      border-color: #17a2b8 !important;
    }

    .segmentador-zone {
      margin-bottom: 15px;
    }

    .segmentador-header {
      border-bottom: 2px solid #dee2e6;
    }

    .segmentador-batches {
      transition: all 0.3s ease;
    }

    .segmentador-batches.drag-over {
      background-color: rgba(40, 167, 69, 0.1) !important;
      border-color: #28a745 !important;
      border-style: solid !important;
    }

    .min-height-400 {
      min-height: 400px;
    }

    .min-height-100 {
      min-height: 100px;
    }

    .batch-count {
      font-size: 0.8em;
      min-width: 25px;
      text-align: center;
    }

    .batch-meta {
      font-size: 0.8em;
      color: #6c757d;
    }

    .batch-status {
      font-size: 0.7em;
      padding: 2px 6px;
      border-radius: 3px;
    }

    /* Animaciones */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .batch-item {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
</head>
<body>
  <!-- Men√∫ hamburguesa elegante -->
  <div class="menu-toggle" onclick="toggleMenu()" id="menuToggle">
    <i class="fas fa-bars"></i>
  </div>

  <!-- Overlay para cerrar men√∫ -->
  <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

  <!-- Men√∫ lateral minimalista -->
  <div class="side-menu" id="sideMenu">
    <div class="menu-header">
      <h5 class="text-white mb-0">
        <i class="fas fa-arrows-alt"></i>
        Asignar Batches
      </h5>
    </div>
    <div class="menu-items">
      <a href="/team" class="menu-item">
        <i class="fas fa-home"></i>
        <span>Inicio</span>
      </a>
      
      <a href="/dashboard" class="menu-item">
        <i class="fas fa-th-large"></i>
        <span>Dashboard</span>
      </a>
      
      <a href="/masks" class="menu-item">
        <i class="fas fa-images"></i>
        <span>M√°scaras</span>
      </a>
    </div>
  </div>

  <div class="container-fluid mt-4 main-content">
    <!-- T√≠tulo Principal -->
    <div class="dashboard-title">
      <h1><i class="fas fa-arrows-alt"></i> ASIGNAR BATCHES</h1>
      <p>Gesti√≥n Visual de Asignaci√≥n por Drag & Drop</p>
    </div>
    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title" style="color: #10B981;">Total Batches</h5>
            <h2 id="totalBatches" style="color: #10B981;">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title" style="color: #059669;">No Segmentados (NS)</h5>
            <h2 id="pendingBatches" style="color: #059669;">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title" style="color: #34D399;">Incompletas (In)</h5>
            <h2 id="inProgressBatches" style="color: #34D399;">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title" style="color: #10B981;">Segmentados (S)</h5>
            <h2 id="completedBatches" style="color: #10B981;">0</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- Control de Vista -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <small class="text-white-50">Asigna batches arrastrando hacia los segmentadores</small>
      </div>
      <div>
        <button type="button" class="btn btn-outline-light btn-sm" onclick="toggleDetailedView()">
          <i class="fas fa-table"></i> Vista Detallada
        </button>
      </div>
    </div>

    <!-- Drag & Drop Batch Assignment Interface -->
    <div class="row">
      <!-- Batches No Asignados -->
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%); color: white; border-bottom: 1px solid rgba(255, 255, 255, 0.2);">
            <h5 class="mb-0"><i class="fas fa-inbox"></i> Batches No Asignados</h5>
            <small style="color: rgba(255, 255, 255, 0.8);">Arrastra los batches hacia los segmentadores</small>
          </div>
          <div class="card-body p-2" style="max-height: 600px; overflow-y: auto;">
            <div id="unassignedBatches" class="drop-zone min-height-400">
              <!-- Los batches no asignados se cargar√°n aqu√≠ -->
              <div class="text-center text-muted p-4">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p>Cargando batches pendientes...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Segmentadores (Divididos en columnas) -->
      <div class="col-md-8">
        <div class="row g-3">
          {% for member in crew %}
          <div class="col-md-6">
            <div class="card h-100" style="border: 2px solid rgba(255, 255, 255, 0.3);">
              <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; border-bottom: none;">
                <h5 class="mb-0 fw-bold"><i class="fas fa-user-circle"></i> {{ member }}</h5>
                <span class="badge batch-count" style="background: white; color: #059669; font-weight: bold; font-size: 0.9rem;">0</span>
              </div>
              <div class="card-body p-2" style="max-height: 300px; overflow-y: auto;">
                <div class="drop-zone segmentador-batches" 
                     data-assignee="{{ member }}" 
                     style="min-height: 200px; background: rgba(255, 255, 255, 0.1); border: 2px dashed rgba(255, 255, 255, 0.4); border-radius: 12px; padding: 1rem; transition: all 0.3s ease;">
                  <!-- Los batches asignados a {{ member }} aparecer√°n aqu√≠ -->
                  <div class="text-center text-white-50 p-3">
                    <i class="fas fa-hand-paper fa-2x mb-2" style="color: #34D399;"></i>
                    <p class="small mb-0 fw-bold">Zona de {{ member }}</p>
                    <p class="small mb-0" style="color: rgba(255, 255, 255, 0.7);">Arrastra batches aqu√≠</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Tabla de Revisi√≥n (Oculta por defecto, para vista detallada) -->
    <div class="card mt-3" id="detailedView" style="display: none;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-clipboard-check"></i> Vista Detallada - Cola de Revisi√≥n</h5>
        <div class="d-flex align-items-center gap-2">
          <small class="text-muted me-3">
            <i class="fas fa-info-circle"></i> 
            Los batches aprobados permanecen aqu√≠ hasta cambiar manualmente el estado a "S"
          </small>
          <button type="button" class="btn btn-secondary btn-sm" onclick="toggleDetailedView()">
            <i class="fas fa-eye-slash"></i> Ocultar Vista Detallada
          </button>
        </div>
      </div>
      <div class="card-body">
        <table id="batchesTable" class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Batch ID</th>
              <th>Responsable</th>
              <th>Cargado a Mongo</th>
              <th>Estatus Segmentaci√≥n</th>
              <th>Fecha Asignaci√≥n</th>
              <th>Revisi√≥n</th>
              <th>Comentarios</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Cierre del contenido principal -->
  </div>

  <!-- Modal para Nuevo Batch -->
  <div class="modal fade" id="newBatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Crear Nuevo Batch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="newBatchForm">
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Batch ID</label>
                  <select class="form-select" id="batch_id" name="batch_id" required>
                    <option value="">Seleccionar batch pendiente...</option>
                    <!-- Los batches se cargar√°n din√°micamente -->
                  </select>
                  <div class="form-text">
                    <i class="fas fa-list"></i> 
                    Selecciona un batch pendiente de segmentaci√≥n
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Responsable</label>
                  <select class="form-select" id="assignee" name="assignee" required>
                    <option value="">Seleccionar...</option>
                    {% for member in crew %}
                    <option value="{{ member }}">{{ member }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Carpeta de Im√°genes</label>
                  <input type="text" class="form-control" id="folder" name="folder" placeholder="/data/batch_XX">
                  <div class="form-text">Ruta completa a la carpeta</div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Fecha L√≠mite</label>
                  <input type="date" class="form-control" id="due_date" name="due_date">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Prioridad</label>
                  <select class="form-select" id="priority" name="priority">
                    <option value="baja">Baja</option>
                    <option value="media" selected>Media</option>
                    <option value="alta">Alta</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Comentarios</label>
              <textarea class="form-control" id="comments" name="comments" rows="3" placeholder="Instrucciones especiales o comentarios..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="createBatch()">
            <i class="fas fa-plus"></i> Crear Batch
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
    // Funciones del men√∫ hamburguesa
    function toggleMenu() {
      const menu = document.getElementById('sideMenu');
      const overlay = document.getElementById('menuOverlay');
      const toggle = document.getElementById('menuToggle');
      
      menu.classList.toggle('open');
      overlay.classList.toggle('show');
      toggle.classList.toggle('active');
    }

    function closeMenu() {
      const menu = document.getElementById('sideMenu');
      const overlay = document.getElementById('menuOverlay');
      const toggle = document.getElementById('menuToggle');
      
      menu.classList.remove('open');
      overlay.classList.remove('show');
      toggle.classList.remove('active');
    }

    // Variables globales
    let batches = [];
    let batchesTable;
    let filterAssignee = '';

    $(document).ready(function() {
      // Inicializar DataTables
      batchesTable = $('#batchesTable').DataTable({
        pageLength: 25,
        order: [[4, 'desc']],
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        },
        columnDefs: [
          { orderable: false, targets: -1 }
        ]
      });

      // Filtro por responsable
      $('#assigneeFilter').on('change', function() {
        const selectedAssignee = this.value;
        
        // Filtrar tabla si est√° visible
        if ($('#detailedView').is(':visible')) {
          batchesTable.column(1).search(selectedAssignee).draw();
        }
        
        // Actualizar estad√≠sticas seg√∫n el filtro
        if (selectedAssignee) {
          // Mostrar estad√≠sticas espec√≠ficas del responsable seleccionado
          filterAssignee = selectedAssignee;
          updateStats(); // Esto llamar√° a updateAssigneeStats con el filtro activo
          
          // Filtrar vista drag & drop
          applyDragDropFilter(selectedAssignee);
        } else {
          // Mostrar estad√≠sticas generales
          filterAssignee = '';
          updateStats(); // Esto mostrar√° las estad√≠sticas generales
          
          // Mostrar todos los segmentadores
          applyDragDropFilter('');
        }
      });

      // Cargar datos
      loadBatches();
      loadMissingBatches();
    });

    function loadBatches() {
      console.log('üîÑ Cargando batches...');
      $.get('/api/batches')
        .done(function(data) {
          console.log('‚úÖ Batches cargados:', data.length);
          console.log('üìä Datos recibidos:', data);
          batches = data;
          updateStats();
          updateDragDropInterface();
          updateTable(); // Solo para la vista detallada
        })
        .fail(function(xhr) {
          console.error('‚ùå Error cargando batches:', xhr);
          alert('Error cargando batches: ' + (xhr.responseJSON?.error || 'Error desconocido'));
        });
    }

    // Nueva funci√≥n para actualizar la interfaz de drag & drop
    function updateDragDropInterface() {
      console.log('üéØ Actualizando interfaz drag & drop...');
      
      // Cargar batches pendientes desde el endpoint de missing-batches
      $.get('/api/missing-batches')
        .done(function(response) {
          console.log('üì• Respuesta de missing-batches:', response);
          
          // Extraer el array de batches de la respuesta
          const missingBatchesList = response.missing_batches || response || [];
          console.log('üì• Batches pendientes cargados:', missingBatchesList.length);
          
          // Obtener batches no asignados de la base de datos
          const unassignedBatchesFromDB = batches.filter(batch => 
            batch.status === 'NS' && !batch.assignee
          );
          
          // Combinar batches pendientes con batches no asignados de la DB
          const allUnassignedBatches = [
            // Batches pendientes (convertir a formato est√°ndar)
            ...missingBatchesList.map(batchId => ({
              id: batchId,
              assignee: null,
              status: 'NS',
              metadata: {
                assigned_at: null,
                due_date: null,
                priority: 'media'
              },
              comments: 'Batch pendiente de asignaci√≥n',
              mongo_uploaded: false,
              isPending: true // Marcador para identificar batches pendientes
            })),
            // Batches no asignados existentes en la DB
            ...unassignedBatchesFromDB
          ];
          
          // Obtener batches asignados por responsable
          const assignedBatches = batches.filter(batch => 
            batch.assignee && (batch.status === 'In' || batch.status === 'NS')
          );
          
          // Renderizar batches no asignados
          renderUnassignedBatches(allUnassignedBatches);
          
          // Renderizar batches asignados por segmentador
          renderAssignedBatches(assignedBatches);
          
          // Inicializar eventos de drag & drop
          initializeDragAndDrop();
        })
        .fail(function(xhr) {
          console.error('‚ùå Error cargando batches pendientes:', xhr);
          // Fallback: usar solo batches de la DB
          const unassignedBatches = batches.filter(batch => 
            batch.status === 'NS' && !batch.assignee
          );
          const assignedBatches = batches.filter(batch => 
            batch.assignee && (batch.status === 'In' || batch.status === 'NS')
          );
          
          renderUnassignedBatches(unassignedBatches);
          renderAssignedBatches(assignedBatches);
          initializeDragAndDrop();
        });
    }

    function renderUnassignedBatches(unassignedBatches) {
      const container = $('#unassignedBatches');
      container.empty();
      
      if (unassignedBatches.length === 0) {
        container.html(`
          <div class="text-center text-muted p-4">
            <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
            <p>¬°Todos los batches est√°n asignados!</p>
          </div>
        `);
        return;
      }
      
      unassignedBatches.forEach(batch => {
        const batchElement = createBatchElement(batch, 'no-assigned');
        container.append(batchElement);
      });
    }

    function renderAssignedBatches(assignedBatches) {
      // Agrupar por responsable
      const batchesByAssignee = {};
      assignedBatches.forEach(batch => {
        if (!batchesByAssignee[batch.assignee]) {
          batchesByAssignee[batch.assignee] = [];
        }
        batchesByAssignee[batch.assignee].push(batch);
      });
      
      // Actualizar contadores y contenido de cada segmentador
      $('.segmentador-batches').each(function() {
        const assignee = $(this).data('assignee');
        const assigneeBatches = batchesByAssignee[assignee] || [];
        
        // Actualizar contador en el header de la tarjeta
        $(this).closest('.card')
          .find('.batch-count')
          .text(assigneeBatches.length);
        
        // Limpiar y agregar batches
        $(this).empty();
        
        if (assigneeBatches.length === 0) {
          $(this).html(`
            <div class="text-center text-white-50 p-3">
              <i class="fas fa-hand-paper fa-2x mb-2" style="color: #34D399;"></i>
              <p class="small mb-0 fw-bold">Zona de ${assignee}</p>
              <p class="small mb-0" style="color: rgba(255, 255, 255, 0.7);">Arrastra batches aqu√≠</p>
            </div>
          `);
        } else {
          assigneeBatches.forEach(batch => {
            const batchElement = createBatchElement(batch, 'assigned');
            $(this).append(batchElement);
          });
        }
      });
    }

    function createBatchElement(batch, type) {
      const statusIcon = batch.status === 'S' ? 'check-circle text-success' :
                        batch.status === 'In' ? 'clock text-warning' :
                        'circle text-secondary';
      
      const reviewIcon = batch.metadata?.review_status === 'aprobado' ? '‚úÖ' :
                        batch.metadata?.review_status === 'no_aprobado' ? '‚ùå' : '';
      
      // Indicador especial para batches pendientes
      const pendingIndicator = batch.isPending ? 
        '<span class="badge bg-info ms-2"><i class="fas fa-inbox"></i> Pendiente</span>' : '';
      
      // Fecha de asignaci√≥n o indicador de pendiente
      const dateInfo = batch.metadata?.assigned_at ? 
        `<i class="fas fa-calendar"></i> ${batch.metadata.assigned_at}` :
        batch.isPending ? 
          '<i class="fas fa-hourglass-start"></i> Sin asignar' : 
          'Sin fecha';
      
      return $(`
        <div class="batch-item ${type} ${batch.isPending ? 'pending-batch' : ''}" 
             draggable="true" 
             data-batch-id="${batch.id}" 
             data-assignee="${batch.assignee || ''}"
             data-is-pending="${batch.isPending || false}">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="fw-bold text-primary mb-1">
                <i class="fas fa-${statusIcon}"></i>
                ${batch.id}
                ${reviewIcon}
                ${pendingIndicator}
              </div>
              <div class="batch-meta">
                <small class="text-muted">
                  ${dateInfo}
                </small>
                ${batch.metadata?.due_date ? `<br><small class="text-warning">
                  <i class="fas fa-clock"></i> Vence: ${batch.metadata.due_date}
                </small>` : ''}
              </div>
            </div>
            <div class="text-end">
              <span class="batch-status badge bg-${batch.status === 'S' ? 'success' : batch.status === 'In' ? 'warning' : 'secondary'}">
                ${batch.status}
              </span>
              ${batch.metadata?.priority === 'alta' ? '<br><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Alta</small>' : ''}
            </div>
          </div>
          ${batch.comments ? `<div class="mt-2"><small class="text-muted">${batch.comments}</small></div>` : ''}
        </div>
      `);
    }

    function initializeDragAndDrop() {
      console.log('üéØ Inicializando drag & drop...');
      
      // Eventos para elementos draggables
      $(document).off('dragstart dragend', '.batch-item');
      $(document).on('dragstart', '.batch-item', function(e) {
        console.log('üñ±Ô∏è Drag started:', $(this).data('batch-id'));
        $(this).addClass('dragging');
        e.originalEvent.dataTransfer.setData('text/plain', $(this).data('batch-id'));
        e.originalEvent.dataTransfer.effectAllowed = 'move';
      });
      
      $(document).on('dragend', '.batch-item', function(e) {
        $(this).removeClass('dragging');
        $('.drop-zone').removeClass('drag-over');
      });
      
      // Eventos para zonas de drop
      $(document).off('dragover dragenter dragleave drop', '.drop-zone');
      
      $(document).on('dragover', '.drop-zone', function(e) {
        e.preventDefault();
        e.originalEvent.dataTransfer.dropEffect = 'move';
      });
      
      $(document).on('dragenter', '.drop-zone', function(e) {
        e.preventDefault();
        $(this).addClass('drag-over');
      });
      
      $(document).on('dragleave', '.drop-zone', function(e) {
        // Solo quitar el highlight si realmente salimos de la zona
        if (!$(this)[0].contains(e.relatedTarget)) {
          $(this).removeClass('drag-over');
        }
      });
      
      $(document).on('drop', '.drop-zone', function(e) {
        e.preventDefault();
        $(this).removeClass('drag-over');
        
        const batchId = e.originalEvent.dataTransfer.getData('text/plain');
        const newAssignee = $(this).data('assignee');
        
        console.log('üì§ Drop:', { batchId, newAssignee });
        
        if (batchId) {
          assignBatchToSegmentador(batchId, newAssignee);
        }
      });
    }

    function assignBatchToSegmentador(batchId, newAssignee) {
      console.log(`üéØ Asignando batch ${batchId} a ${newAssignee || 'sin asignar'}`);
      
      // Verificar si es un batch pendiente o uno existente en la DB
      const isPendingBatch = !batches.find(b => b.id === batchId);
      
      if (isPendingBatch) {
        // Crear nuevo batch desde pendiente
        createBatchFromPending(batchId, newAssignee);
      } else {
        // Actualizar batch existente
        updateExistingBatch(batchId, newAssignee);
      }
    }

    function createBatchFromPending(batchId, assignee) {
      console.log(`üìù Creando nuevo batch desde pendiente: ${batchId}`);
      
      const batchData = {
        id: batchId,
        assignee: assignee,
        folder: `/data/${batchId}`,
        tasks: ["segmentar", "subir_mascaras", "revisar"],
        metadata: {
          assigned_at: new Date().toISOString().split('T')[0],
          due_date: '',
          priority: 'media',
          reviewed_at: null
        },
        status: 'NS',
        mongo_uploaded: false,
        comments: `Batch asignado a ${assignee} desde drag & drop`
      };
      
      $.ajax({
        url: '/api/batches',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(batchData),
        success: function(response) {
          console.log('‚úÖ Nuevo batch creado:', response);
          showNotification(`Batch ${batchId} creado y asignado a ${assignee}`, 'success');
          loadBatches(); // Recargar todo para sincronizar
        },
        error: function(xhr) {
          console.error('‚ùå Error creando batch:', xhr);
          showNotification('Error creando batch: ' + (xhr.responseJSON?.error || 'Error desconocido'), 'error');
          updateDragDropInterface(); // Restaurar interfaz
        }
      });
    }

    function updateExistingBatch(batchId, newAssignee) {
      const batch = batches.find(b => b.id === batchId);
      if (!batch) {
        showNotification('Batch no encontrado', 'error');
        return;
      }
      
      const oldAssignee = batch.assignee;
      
      // Actualizar datos localmente
      batch.assignee = newAssignee || null;
      if (newAssignee && !batch.metadata.assigned_at) {
        batch.metadata.assigned_at = new Date().toISOString().split('T')[0];
      }
      
      // Enviar actualizaci√≥n al servidor
      $.ajax({
        url: `/api/batches/${batchId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({
          assignee: newAssignee || null,
          metadata: batch.metadata
        }),
        success: function(response) {
          console.log('‚úÖ Batch actualizado:', response);
          showNotification(
            newAssignee ? 
              `Batch ${batchId} asignado a ${newAssignee}` : 
              `Batch ${batchId} desasignado`,
            'success'
          );
          updateDragDropInterface();
          updateStats();
        },
        error: function(xhr) {
          console.error('‚ùå Error actualizando batch:', xhr);
          // Revertir cambio local
          batch.assignee = oldAssignee;
          showNotification('Error asignando batch: ' + (xhr.responseJSON?.error || 'Error desconocido'), 'error');
          updateDragDropInterface();
        }
      });
    }

    // Funci√≥n para alternar entre vista drag & drop y vista detallada
    function toggleDetailedView() {
      const detailedView = $('#detailedView');
      if (detailedView.is(':visible')) {
        detailedView.hide();
        $('.btn[onclick="toggleDetailedView()"]').html('<i class="fas fa-table"></i> Vista Detallada');
      } else {
        detailedView.show();
        $('.btn[onclick="toggleDetailedView()"]').html('<i class="fas fa-columns"></i> Vista Drag & Drop');
        updateTable(); // Asegurar que la tabla est√© actualizada
      }
    }

    // Funci√≥n para aplicar filtro en la vista drag & drop
    function applyDragDropFilter(assignee) {
      if (assignee) {
        // Ocultar todos los segmentadores excepto el seleccionado
        $('.segmentador-zone').each(function() {
          const currentAssignee = $(this).find('.drop-zone').data('assignee');
          if (currentAssignee === assignee) {
            $(this).show();
          } else {
            $(this).hide();
          }
        });
        console.log(`üéØ Filtro aplicado: mostrando solo ${assignee}`);
      } else {
        // Mostrar todos los segmentadores
        $('.segmentador-zone').show();
        console.log('üéØ Filtro removido: mostrando todos los segmentadores');
      }
    }

    function updateStats() {
      const total = batches.length;
      // Usar el nuevo sistema de estados: S, In, NS
      const completed = batches.filter(b => b.status === 'S').length; // S = Segmentado (completado)
      const inProgress = batches.filter(b => b.status === 'In').length; // In = Incompletas
      const pending = batches.filter(b => b.status === 'NS').length; // NS = No Segmentado (pendiente)

      $('#totalBatches').text(total);
      $('#pendingBatches').text(pending);
      $('#inProgressBatches').text(inProgress);
      $('#completedBatches').text(completed);
    }

    function updateTable() {
      console.log('üìã Actualizando tabla con', batches.length, 'batches');
      batchesTable.clear();
      
      // Filtrar solo batches que necesitan revisi√≥n (In y NS)
      const batchesForReview = batches.filter(batch => 
        batch.status === 'In' || batch.status === 'NS'
      );
      
      console.log(`üìä Mostrando ${batchesForReview.length} batches pendientes de revisi√≥n de ${batches.length} totales`);
      
      batchesForReview.forEach(function(batch) {
        // Estado de MongoDB (Cargado a Mongo)
        const mongoStatus = batch.mongo_uploaded ? 
          `<i class="fas fa-check-circle text-success" title="S√≠"></i> S√≠` : 
          `<i class="fas fa-times-circle text-danger" title="No"></i> No`;
        
        // Selector de estatus de segmentaci√≥n
        const statusSelect = `
          <select class="form-select form-select-sm segmentation-status-select" data-batch-id="${batch.id}" style="min-width: 120px;">
            <option value="In" ${batch.status === 'In' ? 'selected' : ''}>In - Incompleta</option>
            <option value="NS" ${batch.status === 'NS' ? 'selected' : ''}>NS - No Segmentado</option>
            <option value="S" ${batch.status === 'S' ? 'selected' : ''}>S - Segmentado (QUITAR DE COLA)</option>
          </select>
        `;
        
        // Selector de revisi√≥n con Aprobado/No Aprobado e indicador visual
        const reviewStatus = batch.metadata.review_status || '';
        const reviewSelect = `
          <select class="form-select form-select-sm review-select ${reviewStatus === 'aprobado' ? 'border-success' : reviewStatus === 'no_aprobado' ? 'border-danger' : ''}" 
                  data-batch-id="${batch.id}" style="min-width: 120px;">
            <option value="">Pendiente</option>
            <option value="aprobado" ${reviewStatus === 'aprobado' ? 'selected' : ''}>‚úÖ Aprobado</option>
            <option value="no_aprobado" ${reviewStatus === 'no_aprobado' ? 'selected' : ''}>‚ùå No Aprobado</option>
          </select>
        `;
        
        // Campo de comentarios editable
        const commentsInput = `
          <textarea class="form-control form-control-sm comments-input" 
                    data-batch-id="${batch.id}" 
                    rows="2" 
                    style="min-width: 200px;">${batch.comments || ''}</textarea>
        `;
        
        // Batch ID est√°tico (no editable)
        const batchIdStatic = `
          <span class="batch-id-static fw-bold text-primary" data-batch-id="${batch.id}">
            ${batch.id}
          </span>
        `;
        
        const row = [
          batchIdStatic,
          batch.assignee,
          mongoStatus,
          statusSelect,
          batch.metadata.assigned_at,
          reviewSelect,
          commentsInput,
          `
            <div class="action-buttons">
              <button class="btn btn-sm btn-outline-success" onclick="saveBatchChanges('${batch.id}')" title="Guardar cambios">
                <i class="fas fa-save"></i>
              </button>
              <button class="btn btn-sm btn-outline-info" onclick="viewBatchDetails('${batch.id}')" title="Ver detalles">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteBatchConfirm('${batch.id}')" title="Eliminar batch">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `
        ];
        
        batchesTable.row.add(row);
      });
      
      batchesTable.draw();
    }

    function loadMissingBatches() {
      $.get('/api/missing-batches')
        .done(function(response) {
          const missingBatches = response.missing_batches || response || [];
          const batchSelect = $('#batch_id');
          batchSelect.empty().append('<option value="">Seleccionar batch pendiente...</option>');
          
          missingBatches.forEach(function(batchId) {
            batchSelect.append(`<option value="${batchId}">${batchId}</option>`);
          });
          
          console.log(`‚úÖ ${missingBatches.length} batches pendientes cargados en selector`);
        })
        .fail(function(xhr) {
          console.error('‚ùå Error cargando batches pendientes para selector:', xhr);
        });
    }

    function createBatch() {
      console.log('üÜï Iniciando creaci√≥n de batch...');
      
      const form = document.getElementById('newBatchForm');
      if (!form) {
        console.error('‚ùå No se encontr√≥ el formulario newBatchForm');
        showNotification('Error: Formulario no encontrado', 'error');
        return;
      }
      
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      console.log('üìã Datos del formulario:', data);
      
      // Validar campos requeridos
      if (!data.assignee) {
        showNotification('Por favor selecciona un responsable', 'warning');
        return;
      }
      
      if (!data.batch_id) {
        showNotification('Por favor selecciona un Batch ID', 'warning');
        return;
      }
      
      // Limpiar y formatear el Batch ID
      let batchId = data.batch_id.trim();
      
      console.log('üÜî ID del batch:', batchId);
      
      // Verificar que el ID no exista ya
      if (batches.find(b => b.id === batchId)) {
        showNotification(`El Batch ID "${batchId}" ya existe. Por favor usa otro ID.`, 'warning');
        return;
      }
      
      // Estructurar los datos seg√∫n el nuevo formato
      const batchData = {
        id: batchId,
        assignee: data.assignee,
        folder: data.folder || `/data/${batchId}`,
        tasks: ["segmentar", "subir_mascaras", "revisar"],
        metadata: {
          assigned_at: new Date().toISOString().split('T')[0], // Fecha actual
          due_date: data.due_date || '',
          priority: data.priority || 'media',
          reviewed_at: null
        },
        status: 'NS', // No segmentado por defecto
        mongo_uploaded: false, // No subido por defecto
        comments: data.comments || 'Batch creado desde gesti√≥n drag & drop'
      };
      
      console.log('üì§ Enviando datos:', batchData);
      showNotification('Creando batch...', 'info');
      
      $.ajax({
        url: '/api/batches',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(batchData),
        success: function(response) {
          console.log('‚úÖ Respuesta del servidor:', response);
          if (response.success) {
            $('#newBatchModal').modal('hide');
            form.reset();
            showNotification(`¬°Batch ${response.batch.id} creado exitosamente!`, 'success');
            loadBatches(); // Recargar la interfaz
          } else {
            console.error('‚ùå Error en respuesta:', response);
            showNotification('Error creando batch: ' + response.message, 'error');
          }
        },
        error: function(xhr, status, error) {
          console.error('‚ùå Error AJAX:', {xhr, status, error});
          console.error('‚ùå Respuesta del servidor:', xhr.responseText);
          const errorMsg = xhr.responseJSON?.error || xhr.responseText || 'Error desconocido';
          showNotification('Error creando batch: ' + errorMsg, 'error');
        }
      });
    }

    function showNotification(message, type = 'info') {
      const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
      }[type] || 'alert-info';
      
      const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      $('body').append(alertHtml);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        $('.alert').fadeOut();
      }, 5000);
    }

    function logout() {
      if (confirm('¬øEst√°s seguro de que quieres salir?')) {
        window.location.href = '/';
      }
    }
  </script>
</body>
</html>
