{% extends "base.html" %}

{% block title %}Reporte de Progreso - Métricas{% endblock %}

{% block extra_css_libs %}
<link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
{% endblock %}

{% block page_css %}
{% include 'theme_system.html' %}
<style>
    body {
      background: var(--background);
      min-height: 100vh;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--text-primary);
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      transition: transform 0.2s ease;
      background: var(--surface);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .navbar {
      background: var(--surface) !important;
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-bottom: 1px solid var(--border);
    }

    .btn-primary {
      background: var(--primary);
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      background: var(--primary-light);
    }

    .btn-outline-light {
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      border-radius: 20px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-outline-light:hover {
      background: rgba(255,255,255,0.2);
      border-color: white;
      color: white;
      transform: translateY(-1px);
    }

    /* Título principal */
    .dashboard-title {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.1) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2rem 3rem;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .dashboard-title h1 {
      color: white;
      font-size: 3rem;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      letter-spacing: 2px;
    }

    .dashboard-title p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.2rem;
      margin: 0.5rem 0 0 0;
      font-weight: 300;
    }

    /* Asegurar que el contenido principal tenga el z-index correcto */
    .main-content {
      position: relative;
      z-index: 1;
    }

    /* Estilos para las tarjetas de estadísticas */
    .card-title {
      background: linear-gradient(135deg, #10B981, #34D399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 600;
    }

    /* Estilos para métricas */
    .metric-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.2);
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(16, 185, 129, 0.25);
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #059669;
      margin-bottom: 0.5rem;
    }

    .metric-label {
      font-size: 1rem;
      color: #6B7280;
      font-weight: 500;
    }

    .progress-bar {
      background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
      border-radius: 10px;
    }

    .table {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      overflow: hidden;
    }

    .table thead th {
      background: linear-gradient(135deg, rgba(183, 148, 246, 0.2) 0%, rgba(246, 135, 179, 0.2) 100%);
      border: none;
      color: #6B46C1;
      font-weight: 600;
      padding: 1rem;
    }

    .table tbody tr:hover {
      background: linear-gradient(135deg, rgba(183, 148, 246, 0.1) 0%, rgba(246, 135, 179, 0.1) 100%);
    }

    /* Animaciones */
    .fade-in {
      animation: fadeIn 0.6s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse {
      animation: pulse-animation 2s infinite;
    }

    @keyframes pulse-animation {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Estilos específicos para reportes de progreso */
    .progress-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      transition: all 0.3s ease;
    }

    .progress-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
    }

    .progress-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #059669;
      margin-bottom: 1rem;
    }

    .progress-large {
      height: 25px;
      margin-bottom: 0.5rem;
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
    }

    .stat-number {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .time-estimate {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
      border: 1px solid rgba(245, 158, 11, 0.2);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .time-estimate .card-title {
      color: #D97706;
      margin-bottom: 0.5rem;
    }

    .milestone {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .milestone.completed {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .milestone-title {
      font-weight: 600;
      color: #059669;
    }

    .milestone.completed .milestone-title {
      text-decoration: line-through;
      opacity: 0.7;
    }

    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .trend-up {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
    }

    .trend-down {
      background: rgba(239, 68, 68, 0.1);
      color: #DC2626;
    }

    .trend-neutral {
      background: rgba(107, 114, 128, 0.1);
      color: #6B7280;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Título Principal -->
    <div class="dashboard-title">
      <h1><i class="fas fa-chart-pie"></i> REPORTE DE PROGRESO</h1>
      <p>Análisis temporal y proyecciones del proyecto de segmentación</p>
    </div>

    <!-- Indicadores de Tendencia -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="metric-card text-center">
          <div class="metric-value" id="dailyAverage">0</div>
          <div class="metric-label">Batches/Día (Promedio)</div>
          <div class="mt-2">
            <span class="trend-indicator trend-up" id="dailyTrend">
              <i class="fas fa-arrow-up"></i> +0%
            </span>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="metric-card text-center">
          <div class="metric-value text-warning" id="daysElapsed">0</div>
          <div class="metric-label">Días Transcurridos</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="metric-card text-center">
          <div class="metric-value text-info" id="estimatedDays">0</div>
          <div class="metric-label">Días Estimados para Terminar</div>
        </div>
      </div>
    </div>


    <!-- Estimación de Tiempo -->
    <div class="time-estimate mb-4">
      <h6 class="card-title">
        <i class="fas fa-clock"></i> Estimación de Tiempo para Completar el Proyecto
      </h6>
      <div id="timeEstimateContent">
        <div class="text-center">
          <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
          <p>Calculando estimaciones...</p>
        </div>
      </div>
    </time-estimate>

    <!-- Barra de Progreso General del Proyecto -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Progreso General del Proyecto</h5>
        <div class="progress progress-large mb-3">
          <div class="progress-bar" id="projectProgress" role="progressbar" style="width: 0%"></div>
        </div>
        <div class="progress-stats">
          <div>
            <span class="stat-number text-success" id="completedCount">0</span>
            <small class="text-muted">Completados</small>
          </div>
          <div>
            <span class="stat-number text-warning" id="remainingCount">0</span>
            <small class="text-muted">Restantes</small>
          </div>
          <div>
            <span class="stat-number text-primary" id="totalCount">0</span>
            <small class="text-muted">Total</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Hitos del Proyecto -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-flag"></i> Hitos del Proyecto</h5>
      </div>
      <div class="card-body">
        <div id="milestonesContent">
          <!-- Los hitos se cargarán dinámicamente -->
          <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p>Cargando hitos...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Reporte Detallado de Progreso -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-chart-area"></i> Análisis Detallado de Progreso</h5>
        <button type="button" class="btn btn-outline-light btn-sm" onclick="exportProgressReport()">
          <i class="fas fa-download"></i> Exportar Reporte
        </button>
      </div>
      <div class="card-body">
        <div id="detailedProgressContent">
          <!-- El análisis detallado se cargará dinámicamente -->
          <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p>Generando análisis detallado...</p>
          </div>
        </div>
      </div>
    </div>
</div>
{% endblock %}

{% block extra_js_libs %}
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
{% endblock %}

{% block page_js %}
<script>
    // Variables globales
    let batches = [];
    let projectStartDate = new Date('2025-07-23'); // Fecha de inicio del proyecto

    $(document).ready(function() {
      // Cargar datos
      loadBatches();
    });

    function loadBatches() {
      console.log('🔄 Cargando batches para reportes de progreso...');
      $.get('/api/batches')
        .done(function(data) {
          console.log('✅ Batches cargados:', data.length);
          batches = data;
          updateProgressReports();
        })
        .fail(function(xhr) {
          console.error('❌ Error cargando batches:', xhr);
          alert('Error cargando batches: ' + (xhr.responseJSON?.error || 'Error desconocido'));
        });
    }

    function updateProgressReports() {
      // Calcular estadísticas básicas
      const total = batches.length;
      const completed = batches.filter(b => b.status === 'S').length;
      const remaining = total - completed;
      const completionRate = total > 0 ? ((completed / total) * 100).toFixed(1) : 0;

      // Calcular días transcurridos
      const currentDate = new Date();
      const daysElapsed = Math.ceil((currentDate - projectStartDate) / (1000 * 60 * 60 * 24));

      // Calcular promedio diario
      const dailyAverage = daysElapsed > 0 ? (completed / daysElapsed).toFixed(2) : 0;

      // Estimar días para completar
      const estimatedDays = dailyAverage > 0 ? Math.ceil(remaining / parseFloat(dailyAverage)) : 0;

      // Actualizar indicadores
      $('#dailyAverage').text(dailyAverage);
      $('#daysElapsed').text(daysElapsed);
      $('#estimatedDays').text(estimatedDays);
      $('#completedCount').text(completed);
      $('#remainingCount').text(remaining);
      $('#totalCount').text(total);

      // Actualizar barra de progreso
      $('#projectProgress').css('width', completionRate + '%');

      // Calcular tendencia (simplificada - comparar con promedio histórico)
      const trendElement = $('#dailyTrend');
      if (dailyAverage > 0.5) {
        trendElement.removeClass('trend-down trend-neutral').addClass('trend-up');
        trendElement.html('<i class="fas fa-arrow-up"></i> Buena productividad');
      } else if (dailyAverage < 0.2) {
        trendElement.removeClass('trend-up trend-neutral').addClass('trend-down');
        trendElement.html('<i class="fas fa-arrow-down"></i> Productividad baja');
      } else {
        trendElement.removeClass('trend-up trend-down').addClass('trend-neutral');
        trendElement.html('<i class="fas fa-minus"></i> Productividad normal');
      }

      // Generar estimación de tiempo
      updateTimeEstimate(daysElapsed, dailyAverage, estimatedDays, remaining);

      // Generar hitos
      updateMilestones(completionRate, completed, total);

      // Generar análisis detallado
      updateDetailedAnalysis(daysElapsed, dailyAverage, completionRate, completed, remaining);
    }

    function updateTimeEstimate(daysElapsed, dailyAverage, estimatedDays, remaining) {
      const content = document.getElementById('timeEstimateContent');

      let estimateHtml = `
        <div class="row">
          <div class="col-md-6">
            <div class="card bg-light border-0">
              <div class="card-body text-center">
                <h4 class="text-primary">${daysElapsed}</h4>
                <small>Días desde el inicio</small>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-light border-0">
              <div class="card-body text-center">
                <h4 class="text-info">${estimatedDays}</h4>
                <small>Días estimados restantes</small>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <small class="text-muted">
            <i class="fas fa-info-circle"></i>
            Basado en un promedio de ${dailyAverage} batches completados por día.
            ${remaining} batches restantes por completar.
          </small>
        </div>
      `;

      content.innerHTML = estimateHtml;
    }

    function updateMilestones(completionRate, completed, total) {
      const content = document.getElementById('milestonesContent');

      const milestones = [
        { percentage: 25, title: '25% del proyecto completado', completed: completionRate >= 25 },
        { percentage: 50, title: '50% del proyecto completado', completed: completionRate >= 50 },
        { percentage: 75, title: '75% del proyecto completado', completed: completionRate >= 75 },
        { percentage: 100, title: 'Proyecto completado', completed: completionRate >= 100 },
        { percentage: Math.floor(completionRate), title: `${Math.floor(completionRate)}% actual del progreso`, completed: true }
      ];

      let milestonesHtml = '';

      milestones.forEach(milestone => {
        const milestoneClass = milestone.completed ? 'milestone completed' : 'milestone';
        const icon = milestone.completed ? 'fas fa-check-circle text-success' : 'fas fa-circle text-muted';

        milestonesHtml += `
          <div class="${milestoneClass}">
            <div class="d-flex align-items-center">
              <i class="${icon} me-3"></i>
              <div class="flex-grow-1">
                <div class="milestone-title">${milestone.title}</div>
                <small class="text-muted">${milestone.completed ? 'Completado' : 'Pendiente'}</small>
              </div>
              <div class="text-end">
                <span class="badge bg-primary">${milestone.percentage}%</span>
              </div>
            </div>
          </div>
        `;
      });

      content.innerHTML = milestonesHtml;
    }

    function updateDetailedAnalysis(daysElapsed, dailyAverage, completionRate, completed, remaining) {
      const content = document.getElementById('detailedProgressContent');

      // Calcular estadísticas por responsable
      const byAssignee = {};
      batches.forEach(b => {
        if (!byAssignee[b.assignee]) {
          byAssignee[b.assignee] = { total: 0, completed: 0 };
        }
        byAssignee[b.assignee].total++;
        if (b.status === 'S') byAssignee[b.assignee].completed++;
      });

      // Encontrar el más productivo
      let mostProductive = null;
      let maxCompleted = 0;
      Object.keys(byAssignee).forEach(assignee => {
        if (byAssignee[assignee].completed > maxCompleted) {
          maxCompleted = byAssignee[assignee].completed;
          mostProductive = assignee;
        }
      });

      const analysisHtml = `
        <div class="row">
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">📈 Estadísticas Generales</h6>
            <ul class="list-unstyled">
              <li class="mb-2"><strong>Progreso total:</strong> ${completionRate}% (${completed}/${batches.length})</li>
              <li class="mb-2"><strong>Días activos:</strong> ${daysElapsed} días</li>
              <li class="mb-2"><strong>Productividad diaria:</strong> ${dailyAverage} batches/día</li>
              <li class="mb-2"><strong>Segmentador más productivo:</strong> ${mostProductive || 'N/A'} (${maxCompleted} batches)</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">🎯 Proyecciones</h6>
            <ul class="list-unstyled">
              <li class="mb-2"><strong>Fecha estimada de finalización:</strong> ${calculateEstimatedDate(daysElapsed, remaining, dailyAverage)}</li>
              <li class="mb-2"><strong>Batches restantes:</strong> ${remaining}</li>
              <li class="mb-2"><strong>Ritmo requerido:</strong> ${remaining > 0 ? (remaining / Math.max(estimatedDays, 1)).toFixed(2) : 0} batches/día</li>
              <li class="mb-2"><strong>Estado del proyecto:</strong> <span class="badge bg-${completionRate > 50 ? 'success' : completionRate > 25 ? 'warning' : 'danger'}">${completionRate > 50 ? 'Avanzado' : completionRate > 25 ? 'En progreso' : 'Inicio'}</span></li>
            </ul>
          </div>
        </div>

        <hr class="my-4">

        <h6 class="fw-bold mb-3">👥 Rendimiento por Segmentador</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Segmentador</th>
                <th>Total Asignados</th>
                <th>Completados</th>
                <th>% Completado</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
      `;

      let tableRows = '';
      Object.keys(byAssignee).sort().forEach(assignee => {
        const stats = byAssignee[assignee];
        const rate = stats.total > 0 ? ((stats.completed / stats.total) * 100).toFixed(1) : 0;
        const statusBadge = rate >= 80 ? 'bg-success' : rate >= 50 ? 'bg-warning' : 'bg-danger';
        const statusText = rate >= 80 ? 'Excelente' : rate >= 50 ? 'Bueno' : 'Necesita mejorar';

        tableRows += `
          <tr>
            <td><strong>${assignee}</strong></td>
            <td>${stats.total}</td>
            <td>${stats.completed}</td>
            <td>${rate}%</td>
            <td><span class="badge ${statusBadge}">${statusText}</span></td>
          </tr>
        `;
      });

      const finalHtml = analysisHtml + tableRows + `
            </tbody>
          </table>
        </div>
      `;

      content.innerHTML = finalHtml;
    }

    function calculateEstimatedDate(daysElapsed, remaining, dailyAverage) {
      if (dailyAverage <= 0 || remaining <= 0) return 'N/A';

      const daysNeeded = Math.ceil(remaining / dailyAverage);
      const estimatedDate = new Date();
      estimatedDate.setDate(estimatedDate.getDate() + daysNeeded);

      return estimatedDate.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    function exportProgressReport() {
      const reportData = {
        fecha_generacion: new Date().toISOString(),
        dias_transcurridos: parseInt($('#daysElapsed').text()),
        batches_completados: parseInt($('#completedCount').text()),
        batches_restantes: parseInt($('#remainingCount').text()),
        batches_total: parseInt($('#totalCount').text()),
        promedio_diario: parseFloat($('#dailyAverage').text()),
        dias_estimados: parseInt($('#estimatedDays').text()),
        porcentaje_completado: parseFloat($('#projectProgress').css('width'))
      };

      // Crear CSV
      let csvContent = "Métrica,Valor\\n";
      csvContent += `Fecha de Generación,${reportData.fecha_generacion}\\n`;
      csvContent += `Días Transcurridos,${reportData.dias_transcurridos}\\n`;
      csvContent += `Batches Completados,${reportData.batches_completados}\\n`;
      csvContent += `Batches Restantes,${reportData.batches_restantes}\\n`;
      csvContent += `Batches Total,${reportData.batches_total}\\n`;
      csvContent += `Promedio Diario,${reportData.promedio_diario}\\n`;
      csvContent += `Días Estimados para Terminar,${reportData.dias_estimados}\\n`;
      csvContent += `Porcentaje Completado,${reportData.porcentaje_completado}\\n`;

      // Descargar archivo
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_progreso_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);

      showNotification('Reporte de progreso exportado exitosamente', 'success');
    }

    function showNotification(message, type = 'info') {
      const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
      }[type] || 'alert-info';

      const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;

      $('body').append(alertHtml);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        $('.alert').fadeOut();
      }, 5000);
    }
</script>
{% endblock %}