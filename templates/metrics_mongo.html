{% extends "base.html" %}

{% block title %}Verificar MongoDB - Métricas{% endblock %}

{% block page_css %}
{% include 'theme_system.html' %}
<style>
    body {
      background: var(--background);
      min-height: 100vh;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--text-primary);
    }

    .dashboard-title {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
    }

    .dashboard-title h1 {
      color: var(--text-primary);
      font-size: 1.75rem;
      font-weight: 700;
      margin: 0;
    }

    .dashboard-title p {
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin: 0.5rem 0 0 0;
    }

    .card {
      background: var(--surface);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .metric-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .metric-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .status-ok {
      color: #10B981;
    }

    .status-error {
      color: #EF4444;
    }

    .btn-primary {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #34D399 0%, #10B981 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="dashboard-title">
      <h1><i class="fas fa-database"></i> VERIFICAR MONGODB</h1>
      <p>Estado de conexión y estadísticas de la base de datos</p>
    </div>

    <div class="row">
      <!-- Estado de Conexión -->
      <div class="col-md-4">
        <div class="metric-card">
          <div class="metric-label">Estado de Conexión</div>
          <div class="metric-value" id="connectionStatus">
            <i class="fas fa-spinner fa-spin"></i> Verificando...
          </div>
        </div>
      </div>

      <!-- Total de Colecciones -->
      <div class="col-md-4">
        <div class="metric-card">
          <div class="metric-label">Colecciones</div>
          <div class="metric-value" id="collectionsCount">-</div>
        </div>
      </div>

      <!-- Total de Documentos -->
      <div class="col-md-4">
        <div class="metric-card">
          <div class="metric-label">Total Documentos</div>
          <div class="metric-value" id="documentsCount">-</div>
        </div>
      </div>
    </div>

    <!-- Detalles de Colecciones -->
    <div class="card mt-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-list"></i> Detalle de Colecciones
        </h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Colección</th>
                <th>Documentos</th>
                <th>Tamaño</th>
              </tr>
            </thead>
            <tbody id="collectionsTable">
              <tr>
                <td colspan="3" class="text-center">
                  <i class="fas fa-spinner fa-spin"></i> Cargando...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
    $(document).ready(function() {
      checkMongoConnection();
    });

    function checkMongoConnection() {
      // Verificar estado de conexión a MongoDB
      $.ajax({
        url: '/api/mongo/status',
        method: 'GET',
        success: function(response) {
          if (response.connected) {
            $('#connectionStatus').html('<i class="fas fa-check-circle status-ok"></i> Conectado');
            loadCollections();
          } else {
            $('#connectionStatus').html('<i class="fas fa-times-circle status-error"></i> Desconectado');
          }
        },
        error: function(xhr) {
          $('#connectionStatus').html('<i class="fas fa-exclamation-triangle status-error"></i> Error');
          console.error('Error verificando conexión:', xhr);
        }
      });
    }

    function loadCollections() {
      // Cargar información de colecciones
      $.ajax({
        url: '/api/mongo/collections',
        method: 'GET',
        success: function(response) {
          if (response.collections) {
            const collections = response.collections;
            $('#collectionsCount').text(collections.length);

            let totalDocs = 0;
            let tableHtml = '';

            collections.forEach(function(col) {
              totalDocs += col.count || 0;
              tableHtml += `
                <tr>
                  <td><i class="fas fa-folder"></i> ${col.name}</td>
                  <td>${col.count || 0}</td>
                  <td>${col.size || '-'}</td>
                </tr>
              `;
            });

            $('#documentsCount').text(totalDocs);
            $('#collectionsTable').html(tableHtml);
          }
        },
        error: function(xhr) {
          $('#collectionsTable').html('<tr><td colspan="3" class="text-center text-danger">Error cargando colecciones</td></tr>');
          console.error('Error cargando colecciones:', xhr);
        }
      });
    }
</script>
{% endblock %}
