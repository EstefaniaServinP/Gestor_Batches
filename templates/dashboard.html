<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Segmentaci√≥n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
    .btn-primary:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); }
    .status-pendiente { background-color: #fff3cd; color: #856404; }
    .status-en-progreso { background-color: #d1ecf1; color: #0c5460; }
    .status-completado { background-color: #d4edda; color: #155724; }
    .priority-alta { color: #dc3545; font-weight: bold; }
    .priority-media { color: #fd7e14; }
    .priority-baja { color: #28a745; }
    
    .status-select, .due-date-input {
      transition: background-color 0.3s ease;
    }
    
    .status-select:focus, .due-date-input:focus {
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      border-color: #667eea;
    }
    
    .saving {
      background-color: #fff3cd !important;
    }
    
    .saved {
      background-color: #d4edda !important;
    }
    
    .error {
      background-color: #f8d7da !important;
    }
    
    /* Estilos para botones de acci√≥n */
    .action-buttons .btn {
      margin-right: 2px;
      transition: all 0.2s ease;
    }
    
    .action-buttons .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn-outline-danger:hover {
      background-color: #dc3545;
      border-color: #dc3545;
      color: white;
    }
    
    /* Estilos para los campos de fecha */
    input[type="date"] {
      position: relative;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      filter: invert(0.8);
    }
    
    /* Estilos para los botones de fecha r√°pida */
    .btn-group-sm .btn {
      font-size: 0.75rem;
    }
    
    /* Validaci√≥n visual mejorada */
    .form-control.is-valid {
      border-color: #28a745;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.4.34.4-.34L7 2.67l-.34-.4L3.3 5.67l-1.6-1.6-.34.4z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right calc(0.375em + 0.1875rem) center;
      background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    
    .form-control.is-invalid {
      border-color: #dc3545;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 1.4 1.4M7.2 5.4 5.8 6.8M5.8 7.2l1.4-1.4'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right calc(0.375em + 0.1875rem) center;
      background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">
        <i class="fas fa-tasks"></i> Dashboard de Segmentaci√≥n
        {% if filter_assignee %}
        <small class="text-light"> - {{ filter_assignee }}</small>
        {% endif %}
      </span>
      <div class="d-flex">
        <a href="/" class="btn btn-outline-light me-2">
          <i class="fas fa-users"></i> Equipo
        </a>
        <a href="/masks" class="btn btn-outline-light me-2">
          <i class="fas fa-image"></i> Ver M√°scaras
        </a>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newBatchModal">
          <i class="fas fa-plus"></i> Nuevo Batch
        </button>
        <button class="btn btn-info ms-2" onclick="syncBatchFiles()">
          <i class="fas fa-sync-alt"></i> Sincronizar Archivos
        </button>
        <button class="btn btn-success ms-2" onclick="autoCreateBatches()">
          <i class="fas fa-magic"></i> Crear Batches Auto
        </button>
        <button class="btn btn-secondary ms-2" onclick="checkMongoFiles()">
          <i class="fas fa-database"></i> Verificar MongoDB
        </button>
        <button class="btn btn-warning ms-2" onclick="resetBatches()">
          <i class="fas fa-sync"></i> Recargar Datos
        </button>
        <button class="btn btn-danger ms-2" onclick="forceInitBatches()" title="Forzar recarga desde archivo JSON">
          <i class="fas fa-database"></i> Reinicializar desde JSON
        </button>
        <button class="btn btn-info ms-2" onclick="showTeamMetrics()">
          <i class="fas fa-chart-bar"></i> M√©tricas del Equipo
        </button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title text-primary">Total Batches</h5>
            <h2 id="totalBatches" class="text-primary">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title text-warning">No Segmentados (NS)</h5>
            <h2 id="pendingBatches" class="text-warning">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title text-info">Falta Segmentar (FS)</h5>
            <h2 id="inProgressBatches" class="text-info">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title text-success">Segmentados (S)</h5>
            <h2 id="completedBatches" class="text-success">0</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- Batches Table -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-list"></i> Gesti√≥n de Batches - Carpetas de Segmentaci√≥n</h5>
        <div class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#statusLegendModal">
            <i class="fas fa-info-circle"></i> Leyenda
          </button>
          <label class="me-2">Filtrar por responsable:</label>
          <select id="assigneeFilter" class="form-select form-select-sm" style="width: auto;">
            <option value="">Todos</option>
            {% for member in crew %}
            <option value="{{ member }}">{{ member }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> 
          <strong>Informaci√≥n:</strong> Cada batch representa una carpeta de im√°genes que debe ser procesada para segmentaci√≥n. 
          <br><strong>Carpeta:</strong> Nombre o ruta de la carpeta que contiene las im√°genes a segmentar.
          <br><strong>Edici√≥n r√°pida:</strong> Cambia el estado y fecha l√≠mite directamente en la tabla - se guardan autom√°ticamente.
        </div>
        <table id="batchesTable" class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Batch ID</th>
              <th>Responsable</th>
              <th>Cargado a Mongo</th>
              <th>Estatus Segmentaci√≥n</th>
              <th>Fecha Asignaci√≥n</th>
              <th>Fecha Revisi√≥n</th>
              <th>Prioridad</th>
              <th>Comentarios</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal para Nuevo Batch -->
  <div class="modal fade" id="newBatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Crear Nuevo Batch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="newBatchForm">
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Batch ID</label>
                  <input type="text" class="form-control" id="batch_id" name="batch_id" placeholder="Ej: batch_400, Batch_400" required>
                  <div class="form-text">
                    <i class="fas fa-hashtag"></i> 
                    ID √∫nico para el batch (puede ser personalizado)
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Responsable</label>
                  <select class="form-select" id="assignee" name="assignee" required>
                    <option value="">Seleccionar...</option>
                    {% for member in crew %}
                    <option value="{{ member }}">{{ member }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Carpeta de Im√°genes</label>
                  <input type="text" class="form-control" id="folder" name="folder" required>
                  <div class="form-text">
                    <i class="fas fa-folder"></i> 
                    Nombre/ruta de la carpeta
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Fecha L√≠mite</label>
                  <input type="date" class="form-control" id="due_date" name="due_date">
                  <div class="form-text">
                    <i class="fas fa-calendar"></i> 
                    Fecha l√≠mite para completar el batch (opcional)
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Prioridad</label>
                  <select class="form-select" id="priority" name="priority">
                    <option value="baja">Baja</option>
                    <option value="media" selected>Media</option>
                    <option value="alta">Alta</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Comentarios</label>
              <textarea class="form-control" id="comments" name="comments" rows="3" placeholder="Comentarios adicionales sobre el batch..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning btn-sm me-auto" onclick="debugInfo()">
            <i class="fas fa-bug"></i> Debug Info
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="createBatch()">Crear Batch</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Editar Batch -->
  <div class="modal fade" id="editBatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Batch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editBatchForm">
            <input type="hidden" name="batch_id">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Responsable</label>
                  <select class="form-select" name="assignee">
                    {% for member in crew %}
                    <option value="{{ member }}">{{ member }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Carpeta de Im√°genes</label>
                  <input type="text" class="form-control" name="folder">
                  <div class="form-text">
                    <i class="fas fa-folder"></i> 
                    Ruta o nombre de la carpeta con las im√°genes a procesar
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Estado</label>
                  <select class="form-select" name="status">
                    <option value="pendiente">Pendiente</option>
                    <option value="en-progreso">En Progreso</option>
                    <option value="completado">Completado</option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Fecha L√≠mite</label>
                  <input type="date" class="form-control" name="due_date">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Prioridad</label>
                  <select class="form-select" name="priority">
                    <option value="baja">Baja</option>
                    <option value="media">Media</option>
                    <option value="alta">Alta</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Comentarios</label>
              <textarea class="form-control" name="comments" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="updateBatch()">Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para M√©tricas del Equipo -->
  <div class="modal fade" id="teamMetricsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-chart-bar"></i> M√©tricas del Equipo de Segmentaci√≥n
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="teamMetricsContent">
            <!-- El contenido se genera din√°micamente -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="exportMetrics()">
            <i class="fas fa-download"></i> Exportar M√©tricas
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script>
    let batchesTable;
    let batches = [];
    let filterAssignee = '{{ filter_assignee or "" }}';
    
    // Funci√≥n para mostrar notificaciones
    function showNotification(message, type = 'info') {
      // Crear el contenedor de notificaciones si no existe
      if (!document.getElementById('notificationContainer')) {
        const container = document.createElement('div');
        container.id = 'notificationContainer';
        container.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
          max-width: 400px;
        `;
        document.body.appendChild(container);
      }
      
      // Crear la notificaci√≥n
      const notification = document.createElement('div');
      const alertClass = type === 'success' ? 'alert-success' : 
                        type === 'error' ? 'alert-danger' : 
                        type === 'warning' ? 'alert-warning' : 'alert-info';
      
      notification.className = `alert ${alertClass} alert-dismissible fade show`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 
                           type === 'error' ? 'exclamation-circle' : 
                           type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // Agregar al contenedor
      document.getElementById('notificationContainer').appendChild(notification);
      
      // Auto-remover despu√©s de 5 segundos
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }

    $(document).ready(function() {
      // Inicializar batches desde JSON si es necesario
      initBatches();
      
      // Cargar datos
      loadBatches();
      
      // Inicializar campos del formulario
      initializeFormFields();
      
      // Inicializar DataTable
      batchesTable = $('#batchesTable').DataTable({
        responsive: true,
        pageLength: 25,
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        },
        columnDefs: [
          { orderable: false, targets: -1 }
        ]
      });

      // Filtro por responsable
      $('#assigneeFilter').on('change', function() {
        const selectedAssignee = this.value;
        batchesTable.column(1).search(selectedAssignee).draw();
      });

      // Aplicar filtro autom√°tico si se especifica en la URL
      if (filterAssignee) {
        $('#assigneeFilter').val(filterAssignee);
      }

      // Evento para cuando se abra el modal de nuevo batch
      $('#newBatchModal').on('show.bs.modal', function() {
        // Asegurar que la fecha m√≠nima est√© actualizada
        const today = new Date().toISOString().split('T')[0];
        $('#due_date').attr('min', today);
        
        // Limpiar cualquier validaci√≥n previa
        $('#newBatchForm .form-control').removeClass('is-invalid is-valid');
        $('#newBatchForm .invalid-feedback').remove();
        
        console.log('üìÖ Modal de nuevo batch abierto - fecha m√≠nima actualizada:', today);
      });
    });

    function initBatches() {
      console.log('üîÑ Verificando inicializaci√≥n de batches...');
      $.post('/api/init-batches')
        .done(function(response) {
          console.log('‚úÖ Resultado de inicializaci√≥n:', response);
          if (response.loaded) {
            showNotification(`${response.loaded_count} nuevos batches cargados desde archivo`, 'success');
          } else if (response.existing_count > 0) {
            console.log(`üìä ${response.existing_count} batches ya existentes - no se requiere inicializaci√≥n`);
          }
        })
        .fail(function(xhr) {
          console.error('‚ùå Error en inicializaci√≥n:', xhr.responseJSON);
          showNotification('Error verificando inicializaci√≥n de batches: ' + (xhr.responseJSON?.error || 'Error desconocido'), 'warning');
        });
    }

    // Funci√≥n para inicializar campos del formulario
    function initializeFormFields() {
      // Establecer fecha actual como m√≠nima para el campo de fecha l√≠mite
      const today = new Date().toISOString().split('T')[0];
      $('#due_date').attr('min', today);
      
      // Agregar bot√≥n para establecer fecha l√≠mite autom√°ticamente
      addDateHelpers();
      
      // Agregar validaci√≥n en tiempo real
      addFormValidation();
      
      console.log('üìÖ Campos del formulario inicializados - fecha m√≠nima:', today);
    }

    // Funci√≥n para agregar helpers de fecha
    function addDateHelpers() {
      // Agregar botones de fecha r√°pida
      const dueDateContainer = $('#due_date').parent();
      const quickDateButtons = `
        <div class="mt-2">
          <small class="text-muted">Fecha r√°pida:</small>
          <div class="btn-group btn-group-sm mt-1" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="setQuickDate(1)">+1 d√≠a</button>
            <button type="button" class="btn btn-outline-secondary" onclick="setQuickDate(3)">+3 d√≠as</button>
            <button type="button" class="btn btn-outline-secondary" onclick="setQuickDate(7)">+1 semana</button>
            <button type="button" class="btn btn-outline-secondary" onclick="setQuickDate(14)">+2 semanas</button>
            <button type="button" class="btn btn-outline-warning" onclick="clearDate()">Limpiar</button>
          </div>
        </div>
      `;
      dueDateContainer.append(quickDateButtons);
    }

    // Funci√≥n para establecer fechas r√°pidas
    function setQuickDate(days) {
      const date = new Date();
      date.setDate(date.getDate() + days);
      const formattedDate = date.toISOString().split('T')[0];
      $('#due_date').val(formattedDate);
      console.log(`üìÖ Fecha establecida: +${days} d√≠as = ${formattedDate}`);
    }

    // Funci√≥n para limpiar fecha
    function clearDate() {
      $('#due_date').val('');
      console.log('üìÖ Fecha limpiada');
    }

    // Funci√≥n para agregar validaci√≥n del formulario
    function addFormValidation() {
      // Validaci√≥n del Batch ID en tiempo real
      $('#batch_id').on('input', function() {
        const value = $(this).val().trim();
        const $feedback = $(this).next('.invalid-feedback');
        
        // Remover feedback anterior
        $feedback.remove();
        $(this).removeClass('is-invalid is-valid');
        
        if (value) {
          // Verificar si ya existe
          const exists = batches.find(b => b.id === value || 
                                         b.id === `batch_${value}` || 
                                         b.id === value.replace(/^batch_?/i, ''));
          
          if (exists) {
            $(this).addClass('is-invalid');
            $(this).after('<div class="invalid-feedback">Este Batch ID ya existe</div>');
          } else {
            $(this).addClass('is-valid');
          }
        }
      });
      
      // Auto-formato del Batch ID
      $('#batch_id').on('blur', function() {
        let value = $(this).val().trim();
        if (value && !value.toLowerCase().startsWith('batch')) {
          value = 'batch_' + value;
          $(this).val(value);
        }
      });
    }

    // Funci√≥n para resetear el formulario de nuevo batch
    function resetNewBatchForm() {
      // Reset b√°sico del formulario
      document.getElementById('newBatchForm').reset();
      
      // Limpiar clases de validaci√≥n
      $('#newBatchForm .form-control').removeClass('is-invalid is-valid');
      $('#newBatchForm .invalid-feedback').remove();
      
      // Restablecer fecha m√≠nima
      const today = new Date().toISOString().split('T')[0];
      $('#due_date').attr('min', today);
      
      console.log('üìã Formulario de nuevo batch reseteado');
    }

    function loadBatches() {
      console.log('üîÑ Cargando batches...');
      $.get('/api/batches')
        .done(function(data) {
          console.log('‚úÖ Batches cargados:', data.length);
          console.log('üìä Datos recibidos:', data);
          batches = data;
          updateStats();
          updateTable();
        })
        .fail(function(xhr) {
          console.error('‚ùå Error cargando batches:', xhr);
          alert('Error cargando batches: ' + (xhr.responseJSON?.error || 'Error desconocido'));
        });
    }

    function updateStats() {
      const total = batches.length;
      // Usar el nuevo sistema de estados: S, FS, NS
      const completed = batches.filter(b => b.status === 'S').length; // S = Segmentado (completado)
      const inProgress = batches.filter(b => b.status === 'FS').length; // FS = Falta Segmentar (en progreso)
      const pending = batches.filter(b => b.status === 'NS').length; // NS = No Segmentado (pendiente)

      $('#totalBatches').text(total);
      $('#pendingBatches').text(pending);
      $('#inProgressBatches').text(inProgress);
      $('#completedBatches').text(completed);

      // Estad√≠sticas por responsable
      const byAssignee = {};
      batches.forEach(b => {
        if (!byAssignee[b.assignee]) {
          byAssignee[b.assignee] = { 
            total: 0, 
            pending: 0,     // NS
            inProgress: 0,  // FS  
            completed: 0    // S
          };
        }
        byAssignee[b.assignee].total++;
        if (b.status === 'NS') byAssignee[b.assignee].pending++;
        else if (b.status === 'FS') byAssignee[b.assignee].inProgress++;
        else if (b.status === 'S') byAssignee[b.assignee].completed++;
      });

      console.log('üìä Estad√≠sticas generales:', {total, pending, inProgress, completed});
      console.log('üë• Estad√≠sticas por responsable:', byAssignee);
      
      // Actualizar m√©tricas por responsable en la UI si estamos en una vista espec√≠fica
      updateAssigneeStats(byAssignee);
    }
    
    // Funci√≥n para actualizar estad√≠sticas espec√≠ficas del responsable
    function updateAssigneeStats(byAssignee) {
      // Si estamos en una vista filtrada por responsable, mostrar sus estad√≠sticas espec√≠ficas
      if (filterAssignee && byAssignee[filterAssignee]) {
        const assigneeStats = byAssignee[filterAssignee];
        
        // Actualizar los n√∫meros con las estad√≠sticas del responsable espec√≠fico
        $('#totalBatches').text(assigneeStats.total);
        $('#pendingBatches').text(assigneeStats.pending);
        $('#inProgressBatches').text(assigneeStats.inProgress);
        $('#completedBatches').text(assigneeStats.completed);
        
        // Agregar indicador visual de que son estad√≠sticas espec√≠ficas
        $('.card-title').each(function() {
          const $title = $(this);
          const originalText = $title.text().replace(` - ${filterAssignee}`, '');
          $title.text(`${originalText} - ${filterAssignee}`);
        });
        
        console.log(`üìä Estad√≠sticas de ${filterAssignee}:`, assigneeStats);
      }
      
      // Crear un resumen por responsable en la consola
      console.log('üìà RESUMEN POR RESPONSABLE:');
      Object.keys(byAssignee).forEach(assignee => {
        const stats = byAssignee[assignee];
        const completionRate = ((stats.completed / stats.total) * 100).toFixed(1);
        console.log(`üë§ ${assignee}: ${stats.total} total, ${stats.completed} completados (${completionRate}%), ${stats.inProgress} en progreso, ${stats.pending} pendientes`);
      });
    }

    function updateTable() {
      console.log('üìã Actualizando tabla con', batches.length, 'batches');
      batchesTable.clear();
      
      batches.forEach(function(batch, index) {
        console.log(`Procesando batch ${index + 1}:`, batch);
        const priorityClass = `priority-${batch.metadata.priority}`;
        
        // Estado de MongoDB (Cargado a Mongo)
        const mongoStatus = batch.mongo_uploaded ? 
          `<i class="fas fa-check-circle text-success" title="S√≠"></i> S√≠` : 
          `<i class="fas fa-times-circle text-danger" title="No"></i> No`;
        
        // Selector de estatus de segmentaci√≥n
        const statusSelect = `
          <select class="form-select form-select-sm segmentation-status-select" data-batch-id="${batch.id}" style="min-width: 80px;">
            <option value="S" ${batch.status === 'S' ? 'selected' : ''}>S - Segmentado</option>
            <option value="FS" ${batch.status === 'FS' ? 'selected' : ''}>FS - Falta Segmentar</option>
            <option value="NS" ${batch.status === 'NS' ? 'selected' : ''}>NS - No Segmentado</option>
          </select>
        `;
        
        // Badge del estatus para mejor visualizaci√≥n
        let statusBadge = '';
        switch(batch.status) {
          case 'S':
            statusBadge = '<span class="badge bg-success">S</span>';
            break;
          case 'FS':
            statusBadge = '<span class="badge bg-warning">FS</span>';
            break;
          case 'NS':
            statusBadge = '<span class="badge bg-secondary">NS</span>';
            break;
        }
        
        // Input de fecha de revisi√≥n editable
        const reviewDateInput = `
          <input type="date" class="form-control form-control-sm review-date-input" 
                 data-batch-id="${batch.id}" 
                 value="${batch.metadata.reviewed_at || ''}" 
                 style="min-width: 130px;">
        `;
        
        // Campo de comentarios editable
        const commentsInput = `
          <textarea class="form-control form-control-sm comments-input" 
                    data-batch-id="${batch.id}" 
                    rows="2" 
                    style="min-width: 200px;">${batch.comments || ''}</textarea>
        `;
        
        // Selector de prioridad editable
        const prioritySelect = `
          <select class="form-select form-select-sm priority-select" data-batch-id="${batch.id}" style="min-width: 90px;">
            <option value="baja" ${batch.metadata.priority === 'baja' ? 'selected' : ''}>Baja</option>
            <option value="media" ${batch.metadata.priority === 'media' ? 'selected' : ''}>Media</option>
            <option value="alta" ${batch.metadata.priority === 'alta' ? 'selected' : ''}>Alta</option>
          </select>
        `;
        
        // Input de Batch ID editable
        const batchIdInput = `
          <input type="text" class="form-control form-control-sm batch-id-input" 
                 data-batch-id="${batch.id}" 
                 value="${batch.id}" 
                 style="min-width: 120px;">
        `;
        
        const row = [
          batchIdInput,
          batch.assignee,
          mongoStatus,
          statusSelect,
          batch.metadata.assigned_at,
          reviewDateInput,
          prioritySelect,
          commentsInput,
          `
            <div class="action-buttons">
              <button class="btn btn-sm btn-outline-success" onclick="saveBatchChanges('${batch.id}')" title="Guardar cambios">
                <i class="fas fa-save"></i>
              </button>
              <button class="btn btn-sm btn-outline-info" onclick="viewBatchDetails('${batch.id}')" title="Ver detalles">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteBatchConfirm('${batch.id}')" title="Eliminar batch">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `
        ];
        
        batchesTable.row.add(row);
      });
      
      batchesTable.draw();
      
      // Aplicar filtro autom√°tico si se especifica
      if (filterAssignee) {
        batchesTable.column(1).search(filterAssignee).draw();
      }
      
      // Agregar eventos para cambios inline
      addInlineEditEvents();
      
      console.log('‚úÖ Tabla actualizada');
    }

    function createBatch() {
      console.log('üÜï Iniciando creaci√≥n de batch...');
      
      const form = document.getElementById('newBatchForm');
      if (!form) {
        console.error('‚ùå No se encontr√≥ el formulario newBatchForm');
        showNotification('Error: Formulario no encontrado', 'error');
        return;
      }
      
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      console.log('üìã Datos del formulario:', data);
      
      // Validar campos requeridos
      if (!data.assignee) {
        showNotification('Por favor selecciona un responsable', 'warning');
        return;
      }
      
      if (!data.batch_id) {
        showNotification('Por favor ingresa un Batch ID', 'warning');
        return;
      }
      
      if (!data.folder) {
        showNotification('Por favor ingresa la carpeta de im√°genes', 'warning');
        return;
      }
      
      // Limpiar y formatear el Batch ID
      let batchId = data.batch_id.trim();
      // Si no empieza con "batch" o "Batch", agregarlo
      if (!batchId.toLowerCase().startsWith('batch')) {
        batchId = 'batch_' + batchId;
      }
      // Reemplazar espacios con guiones bajos
      batchId = batchId.replace(/\s+/g, '_');
      
      console.log('üÜî ID del batch:', batchId);
      
      // Verificar que el ID no exista ya
      if (batches.find(b => b.id === batchId)) {
        showNotification(`El Batch ID "${batchId}" ya existe. Por favor usa otro ID.`, 'warning');
        return;
      }
      
      // Estructurar los datos seg√∫n el nuevo formato
      const batchData = {
        id: batchId,
        assignee: data.assignee,
        folder: data.folder || `/data/${batchId}`,
        tasks: ["segmentar", "subir_mascaras", "revisar"],
        metadata: {
          assigned_at: new Date().toISOString().split('T')[0], // Fecha actual
          due_date: data.due_date || '',
          priority: data.priority || 'media',
          reviewed_at: null
        },
        status: 'NS', // No segmentado por defecto
        mongo_uploaded: false, // No subido por defecto
        comments: data.comments || 'Batch creado desde dashboard'
      };
      
      console.log('üì§ Enviando datos:', batchData);
      showNotification('Creando batch...', 'info');
      
      $.ajax({
        url: '/api/batches',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(batchData),
        success: function(response) {
          console.log('‚úÖ Respuesta del servidor:', response);
          if (response.success) {
            $('#newBatchModal').modal('hide');
            resetNewBatchForm();
            showNotification(`¬°Batch ${response.batch.id} creado exitosamente!`, 'success');
            loadBatches(); // Recargar la tabla
          } else {
            console.error('‚ùå Error en respuesta:', response);
            showNotification('Error creando batch: ' + response.message, 'error');
          }
        },
        error: function(xhr, status, error) {
          console.error('‚ùå Error AJAX:', {xhr, status, error});
          console.error('‚ùå Respuesta del servidor:', xhr.responseText);
          const errorMsg = xhr.responseJSON?.error || xhr.responseText || 'Error desconocido';
          showNotification('Error creando batch: ' + errorMsg, 'error');
        }
      });
    }

    // Funci√≥n de debug para mostrar informaci√≥n del sistema
    function debugInfo() {
      const debugData = {
        timestamp: new Date().toISOString(),
        total_batches: batches.length,
        form_data: {
          batch_id: document.getElementById('batch_id').value,
          assignee: document.getElementById('assignee').value,
          folder: document.getElementById('folder').value,
          due_date: document.getElementById('due_date').value,
          priority: document.getElementById('priority').value,
          comments: document.getElementById('comments').value
        },
        browser_info: {
          userAgent: navigator.userAgent,
          language: navigator.language,
          cookieEnabled: navigator.cookieEnabled
        },
        page_state: {
          current_filter: $('#responsibleFilter').val(),
          total_displayed_rows: $('#batchesTable tbody tr').length
        },
        recent_console_logs: 'Revisa la consola del navegador (F12) para m√°s detalles'
      };

      console.log('üêõ DEBUG INFO COMPLETA:', debugData);
      
      // Mostrar en un modal o alert
      const debugText = `DEBUG INFO (${new Date().toLocaleString()}):
      
üìä Total Batches: ${debugData.total_batches}
üéØ Filtro Actual: ${debugData.page_state.current_filter}
üìù Filas Mostradas: ${debugData.page_state.total_displayed_rows}

üìã DATOS DEL FORMULARIO:
- Batch ID: "${debugData.form_data.batch_id}"
- Responsable: "${debugData.form_data.assignee}"
- Carpeta: "${debugData.form_data.folder}"
- Fecha L√≠mite: "${debugData.form_data.due_date}"
- Prioridad: "${debugData.form_data.priority}"
- Comentarios: "${debugData.form_data.comments}"

üåê NAVEGADOR:
- ${debugData.browser_info.userAgent}
- Idioma: ${debugData.browser_info.language}
- Cookies: ${debugData.browser_info.cookieEnabled ? 'Habilitadas' : 'Deshabilitadas'}

üí° NOTA: Informaci√≥n completa disponible en la consola del navegador (presiona F12)`;

      alert(debugText);
      showNotification('Informaci√≥n de debug generada - revisa la consola (F12)', 'info');
    }

    function editBatch(batchId) {
      const batch = batches.find(b => b.id === batchId);
      if (!batch) return;
      
      const form = document.getElementById('editBatchForm');
      form.batch_id.value = batch.id;
      form.assignee.value = batch.assignee;
      form.folder.value = batch.folder || '';
      form.status.value = batch.status;
      form.due_date.value = batch.metadata.due_date;
      form.priority.value = batch.metadata.priority;
      form.comments.value = batch.comments || '';
      
      $('#editBatchModal').modal('show');
    }

    function updateBatch() {
      const formData = new FormData(document.getElementById('editBatchForm'));
      const data = Object.fromEntries(formData.entries());
      const batchId = data.batch_id;
      delete data.batch_id;
      
      $.ajax({
        url: `/api/batches/${batchId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
          $('#editBatchModal').modal('hide');
          loadBatches();
          alert('Batch actualizado exitosamente');
        },
        error: function(xhr) {
          alert('Error actualizando batch: ' + xhr.responseJSON.error);
        }
      });
    }
    
    // Funci√≥n para guardar cambios de un batch
    function saveBatchChanges(batchId) {
      const batch = batches.find(b => b.id === batchId);
      if (!batch) return;
      
      // Obtener valores de los campos editables
      const segmentationStatus = $(`.segmentation-status-select[data-batch-id="${batchId}"]`).val();
      const reviewDate = $(`.review-date-input[data-batch-id="${batchId}"]`).val();
      const comments = $(`.comments-input[data-batch-id="${batchId}"]`).val();
      
      // Actualizar el objeto batch
      batch.status = segmentationStatus;
      batch.metadata.reviewed_at = reviewDate;
      batch.comments = comments;
      
      // Enviar actualizaci√≥n al servidor
      $.ajax({
        url: `/api/batches/${batchId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({
          status: segmentationStatus,
          metadata: batch.metadata,
          comments: comments
        }),
        success: function(response) {
          if (response.success) {
            showNotification('Batch actualizado exitosamente', 'success');
            // Actualizar estad√≠sticas
            updateStatistics();
          } else {
            showNotification('Error actualizando batch: ' + response.message, 'error');
          }
        },
        error: function(xhr) {
          showNotification('Error actualizando batch: ' + (xhr.responseJSON?.error || 'Error desconocido'), 'error');
        }
      });
    }
    
    // Funci√≥n para ver detalles de un batch
    function viewBatchDetails(batchId) {
      const batch = batches.find(b => b.id === batchId);
      if (!batch) return;
      
      const mongoStatusText = batch.mongo_uploaded ? 'S√≠' : 'No';
      const statusText = {
        'S': 'Segmentado Completo',
        'FS': 'Falta Segmentar',
        'NS': 'No Segmentado'
      }[batch.status] || batch.status;
      
      const modalContent = `
        <div class="row">
          <div class="col-md-6">
            <h6>Informaci√≥n General</h6>
            <p><strong>ID:</strong> ${batch.id}</p>
            <p><strong>Responsable:</strong> ${batch.assignee}</p>
            <p><strong>Carpeta:</strong> ${batch.folder}</p>
            <p><strong>Prioridad:</strong> ${batch.metadata.priority}</p>
          </div>
          <div class="col-md-6">
            <h6>Estado y Fechas</h6>
            <p><strong>Cargado a MongoDB:</strong> ${mongoStatusText}</p>
            <p><strong>Estatus:</strong> ${statusText}</p>
            <p><strong>Fecha Asignaci√≥n:</strong> ${batch.metadata.assigned_at || 'No asignada'}</p>
            <p><strong>Fecha Revisi√≥n:</strong> ${batch.metadata.reviewed_at || 'Pendiente'}</p>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <h6>Comentarios</h6>
            <p class="text-muted">${batch.comments || 'Sin comentarios'}</p>
          </div>
        </div>
      `;
      
      // Mostrar modal con informaci√≥n
      const modal = `
        <div class="modal fade" id="batchDetailsModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Detalles del Batch ${batchId}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                ${modalContent}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remover modal anterior si existe
      $('#batchDetailsModal').remove();
      
      // Agregar y mostrar modal
      $('body').append(modal);
      $('#batchDetailsModal').modal('show');
    }
    
    // Funci√≥n para ver archivos de un batch
    function viewBatchFiles(batchId) {
      $.ajax({
        url: `/api/batch-files/${batchId}`,
        method: 'GET',
        success: function(response) {
          if (response.success) {
            const fileInfo = response.file_info;
            let modalContent = '';
            
            if (fileInfo.count > 0) {
              modalContent = `
                <p><strong>Archivos encontrados:</strong> ${fileInfo.count}</p>
                <p><strong>√öltima subida:</strong> ${new Date(fileInfo.latest_upload).toLocaleString('es-ES')}</p>
                <p><strong>Subido por:</strong> ${fileInfo.uploaded_by}</p>
                <p><strong>Tama√±o total:</strong> ${(fileInfo.total_size / (1024*1024)).toFixed(2)} MB</p>
                <hr>
                <p><a href="/masks" target="_blank" class="btn btn-primary">Ver todos los archivos en MongoDB</a></p>
              `;
            } else {
              modalContent = `
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle"></i>
                  No se encontraron archivos para el batch <strong>${batchId}</strong> en MongoDB.
                </div>
                <p>Los archivos deben seguir el patr√≥n: <code>masks_batch_${batchId.replace('batch-', '')}.tar.xz</code></p>
              `;
            }
            
            // Mostrar modal con informaci√≥n
            const modal = `
              <div class="modal fade" id="fileInfoModal" tabindex="-1">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Archivos del Batch ${batchId}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      ${modalContent}
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            // Remover modal anterior si existe
            $('#fileInfoModal').remove();
            
            // Agregar y mostrar modal
            $('body').append(modal);
            $('#fileInfoModal').modal('show');
            
          } else {
            showNotification('Error al obtener informaci√≥n de archivos: ' + response.message, 'error');
          }
        },
        error: function() {
          showNotification('Error al conectar con el servidor', 'error');
        }
      });
    }

    function deleteBatchConfirm(batchId) {
      const batch = batches.find(b => b.id === batchId);
      if (!batch) {
        showNotification('Batch no encontrado', 'error');
        return;
      }
      
      // Crear modal de confirmaci√≥n personalizado
      const confirmationModal = `
        <div class="modal fade" id="deleteBatchModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                  <i class="fas fa-exclamation-triangle"></i> Confirmar Eliminaci√≥n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="alert alert-warning">
                  <i class="fas fa-warning"></i>
                  <strong>¬°Atenci√≥n!</strong> Esta acci√≥n no se puede deshacer.
                </div>
                <p><strong>¬øEst√°s seguro de que quieres eliminar el siguiente batch?</strong></p>
                <div class="card bg-light">
                  <div class="card-body">
                    <p class="mb-1"><strong>Batch ID:</strong> ${batch.id}</p>
                    <p class="mb-1"><strong>Responsable:</strong> ${batch.assignee}</p>
                    <p class="mb-1"><strong>Estado:</strong> ${batch.status}</p>
                    <p class="mb-0"><strong>Comentarios:</strong> ${batch.comments || 'Sin comentarios'}</p>
                  </div>
                </div>
                <p class="mt-3 text-muted">
                  <small>
                    <i class="fas fa-info-circle"></i>
                    El batch ser√° eliminado permanentemente del sistema y de la base de datos.
                  </small>
                </p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteBatch('${batchId}')">
                  <i class="fas fa-trash"></i> S√≠, Eliminar Batch
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remover modal anterior si existe
      $('#deleteBatchModal').remove();
      
      // Agregar y mostrar modal
      $('body').append(confirmationModal);
      $('#deleteBatchModal').modal('show');
      
      // Auto-remover modal cuando se cierre
      $('#deleteBatchModal').on('hidden.bs.modal', function() {
        $(this).remove();
      });
    }

    function deleteBatch(batchId) {
      console.log(`üóëÔ∏è Eliminando batch: ${batchId}`);
      showNotification('Eliminando batch...', 'info');
      
      $.ajax({
        url: `/api/batches/${batchId}`,
        method: 'DELETE',
        success: function(response) {
          $('#deleteBatchModal').modal('hide');
          
          if (response.success) {
            showNotification(`Batch ${batchId} eliminado exitosamente`, 'success');
            loadBatches(); // Recargar la tabla
          } else {
            showNotification('Error eliminando batch: ' + response.message, 'error');
          }
        },
        error: function(xhr) {
          $('#deleteBatchModal').modal('hide');
          const errorMsg = xhr.responseJSON?.error || 'Error desconocido';
          showNotification('Error eliminando batch: ' + errorMsg, 'error');
          console.error(`‚ùå Error eliminando batch ${batchId}:`, xhr);
        }
      });
    }
    
    // Funci√≥n para sincronizar archivos entre batches y MongoDB
    function syncBatchFiles() {
      showNotification('Sincronizando archivos con MongoDB...', 'info');
      
      $.ajax({
        url: '/api/sync-batch-files',
        method: 'POST',
        success: function(response) {
          if (response.success) {
            showNotification(`Sincronizaci√≥n completa. ${response.batches_updated} batches actualizados.`, 'success');
            loadBatches(); // Recargar la tabla
            
            // Mostrar detalles si hay cambios
            if (response.batches_updated > 0) {
              console.log('üìä Resultados de sincronizaci√≥n:', response.results);
              
              // Mostrar batches que cambiaron
              const updatedBatches = response.results.filter(r => r.updated);
              if (updatedBatches.length > 0) {
                const batchNames = updatedBatches.map(b => b.batch_id).join(', ');
                showNotification(`Batches actualizados: ${batchNames}`, 'info');
              }
            }
          } else {
            showNotification('Error en la sincronizaci√≥n: ' + response.error, 'error');
          }
        },
        error: function(xhr) {
          const errorMsg = xhr.responseJSON?.error || 'Error desconocido';
          showNotification('Error al conectar con el servidor para sincronizaci√≥n: ' + errorMsg, 'error');
        }
      });
    }

    // Nueva funci√≥n para crear batches autom√°ticamente
    function autoCreateBatches() {
      const confirmMessage = `ü§ñ Creaci√≥n Autom√°tica de Batches

Esta funci√≥n va a:
‚Ä¢ Escanear todos los archivos en MongoDB
‚Ä¢ Extraer n√∫meros de batch de los nombres de archivos
‚Ä¢ Crear autom√°ticamente los batches que falten
‚Ä¢ Asignarlos por defecto a "Maggie" (puedes cambiar despu√©s)

¬øQuieres continuar?`;

      if (!confirm(confirmMessage)) {
        return;
      }
      
      showNotification('Creando batches autom√°ticamente...', 'info');
      
      $.ajax({
        url: '/api/auto-create-batches',
        method: 'POST',
        success: function(response) {
          if (response.success) {
            showNotification(`¬°√âxito! ${response.created_batches} nuevos batches creados de ${response.total_found} encontrados`, 'success');
            loadBatches(); // Recargar la tabla
            
            // Mostrar detalles
            if (response.created_batches > 0) {
              const createdBatches = response.results.filter(r => r.created);
              const batchNames = createdBatches.map(b => b.batch_id).join(', ');
              showNotification(`Batches creados: ${batchNames}`, 'info');
              
              // Ejecutar sincronizaci√≥n autom√°ticamente despu√©s
              setTimeout(() => {
                showNotification('Sincronizando archivos...', 'info');
                syncBatchFiles();
              }, 2000);
            }
          } else {
            showNotification('Error en creaci√≥n autom√°tica: ' + response.error, 'error');
          }
        },
        error: function(xhr) {
          const errorMsg = xhr.responseJSON?.error || 'Error desconocido';
          showNotification('Error en creaci√≥n autom√°tica: ' + errorMsg, 'error');
        }
      });
    }

    // Nueva funci√≥n para verificar archivos en MongoDB
    function checkMongoFiles() {
      showNotification('Verificando archivos en MongoDB...', 'info');
      
      $.ajax({
        url: '/api/check-mongo-files',
        method: 'GET',
        timeout: 30000, // 30 segundos de timeout
        success: function(response) {
          if (response.success) {
            // Crear modal con informaci√≥n de archivos
            let modalContent = `
              <div class="alert alert-info">
                <i class="fas fa-database"></i>
                <strong>Total de archivos en MongoDB:</strong> ${response.total_files}
              </div>
              
              <h6>üìÅ Archivos por Batch:</h6>
              <div class="row">
            `;
            
            if (Object.keys(response.batch_patterns).length > 0) {
              Object.keys(response.batch_patterns).sort().forEach(batchKey => {
                const files = response.batch_patterns[batchKey];
                modalContent += `
                  <div class="col-md-6 mb-2">
                    <div class="card card-body bg-light">
                      <h6 class="text-primary">${batchKey}</h6>
                      <small>${files.length} archivo(s):</small>
                      <ul class="list-unstyled mb-0">
                `;
                files.slice(0, 3).forEach(filename => {
                  modalContent += `<li><small><i class="fas fa-file"></i> ${filename}</small></li>`;
                });
                if (files.length > 3) {
                  modalContent += `<li><small class="text-muted">... y ${files.length - 3} m√°s</small></li>`;
                }
                modalContent += `
                      </ul>
                    </div>
                  </div>
                `;
              });
            } else {
              modalContent += `
                <div class="col-12">
                  <div class="alert alert-warning">
                    No se encontraron archivos con patrones de batch reconocibles.
                  </div>
                </div>
              `;
            }
            
            modalContent += `
              </div>
              
              <h6 class="mt-3">üìÑ Archivos Recientes:</h6>
              <div class="table-responsive" style="max-height: 300px;">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Archivo</th>
                      <th>Fecha</th>
                      <th>Tama√±o (MB)</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            
            response.recent_files.slice(0, 10).forEach(file => {
              modalContent += `
                <tr>
                  <td><small>${file.filename}</small></td>
                  <td><small>${file.uploadDate ? new Date(file.uploadDate).toLocaleString('es-ES') : 'N/A'}</small></td>
                  <td><small>${file.size_mb}</small></td>
                </tr>
              `;
            });
            
            modalContent += `
                  </tbody>
                </table>
              </div>
            `;
            
            // Mostrar modal
            const modal = `
              <div class="modal fade" id="mongoFilesModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">
                        <i class="fas fa-database"></i> Archivos en MongoDB
                      </h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      ${modalContent}
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-primary" onclick="syncBatchFiles(); $('#mongoFilesModal').modal('hide');">
                        <i class="fas fa-sync-alt"></i> Sincronizar Ahora
                      </button>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            // Remover modal anterior y mostrar nuevo
            $('#mongoFilesModal').remove();
            $('body').append(modal);
            $('#mongoFilesModal').modal('show');
            
            showNotification(`Verificaci√≥n completa: ${response.total_files} archivos encontrados`, 'success');
            
          } else {
            console.error('Error response:', response);
            const errorMsg = response.error || 'Error desconocido';
            const errorType = response.error_type || 'Unknown';
            showNotification(`Error verificando MongoDB (${errorType}): ${errorMsg}`, 'error');
          }
        },
        error: function(xhr, status, error) {
          console.error('AJAX Error:', {xhr, status, error});
          console.error('Response Text:', xhr.responseText);
          
          let errorMsg = 'Error de conexi√≥n';
          if (xhr.responseJSON && xhr.responseJSON.error) {
            errorMsg = xhr.responseJSON.error;
          } else if (xhr.responseText) {
            try {
              const parsed = JSON.parse(xhr.responseText);
              errorMsg = parsed.error || errorMsg;
            } catch (e) {
              errorMsg = xhr.responseText;
            }
          } else if (status === 'timeout') {
            errorMsg = 'Timeout - La operaci√≥n tard√≥ demasiado';
          } else if (error) {
            errorMsg = error;
          }
          
          showNotification(`Error verificando MongoDB: ${errorMsg}`, 'error');
        }
      });
    }

    function resetBatches() {
      if (!confirm('¬øEst√°s seguro de que quieres recargar todos los datos desde el archivo JSON? Esto sobrescribir√° cualquier cambio no guardado.')) return;
      
      $.ajax({
        url: '/api/reset-batches',
        method: 'POST',
        success: function(response) {
          loadBatches();
          alert(response.message);
        },
        error: function(xhr) {
          alert('Error recargando datos: ' + xhr.responseJSON.error);
        }
      });
    }

    // Nueva funci√≥n para forzar la inicializaci√≥n
    function forceInitBatches() {
      const confirmMessage = `‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è

Esta acci√≥n va a:
‚Ä¢ Eliminar TODOS los batches existentes en la base de datos
‚Ä¢ Cargar los batches desde el archivo batches.json
‚Ä¢ Perder cualquier batch creado que no est√© en el archivo JSON

¬øEst√°s completamente seguro de que quieres continuar?

Escribe "CONFIRMAR" para proceder:`;

      const userInput = prompt(confirmMessage);
      
      if (userInput !== "CONFIRMAR") {
        showNotification('Operaci√≥n cancelada', 'info');
        return;
      }
      
      showNotification('Forzando reinicializaci√≥n desde archivo JSON...', 'warning');
      
      $.ajax({
        url: '/api/init-batches',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ force: true }),
        success: function(response) {
          if (response.success) {
            showNotification(`Reinicializaci√≥n completa: ${response.loaded_count} batches cargados desde JSON`, 'success');
            loadBatches(); // Recargar la tabla
          } else {
            showNotification('Error en reinicializaci√≥n: ' + response.error, 'error');
          }
        },
        error: function(xhr) {
          const errorMsg = xhr.responseJSON?.error || 'Error desconocido';
          showNotification('Error forzando reinicializaci√≥n: ' + errorMsg, 'error');
        }
      });
    }

    // Funci√≥n para mostrar m√©tricas del equipo
    function showTeamMetrics() {
      // Calcular estad√≠sticas por responsable
      const byAssignee = {};
      batches.forEach(b => {
        if (!byAssignee[b.assignee]) {
          byAssignee[b.assignee] = { 
            total: 0, 
            pending: 0,     // NS
            inProgress: 0,  // FS  
            completed: 0,   // S
            batches: []
          };
        }
        byAssignee[b.assignee].total++;
        byAssignee[b.assignee].batches.push(b);
        if (b.status === 'NS') byAssignee[b.assignee].pending++;
        else if (b.status === 'FS') byAssignee[b.assignee].inProgress++;
        else if (b.status === 'S') byAssignee[b.assignee].completed++;
      });

      // Generar HTML para las m√©tricas
      let metricsHtml = `
        <div class="row mb-4">
          <div class="col-12">
            <h6 class="fw-bold">üìä Resumen General del Equipo</h6>
            <div class="row">
              <div class="col-md-3">
                <div class="card bg-primary text-white">
                  <div class="card-body text-center">
                    <h4>${batches.length}</h4>
                    <small>Total Batches</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-success text-white">
                  <div class="card-body text-center">
                    <h4>${batches.filter(b => b.status === 'S').length}</h4>
                    <small>Completados (S)</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-warning text-white">
                  <div class="card-body text-center">
                    <h4>${batches.filter(b => b.status === 'FS').length}</h4>
                    <small>En Progreso (FS)</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-secondary text-white">
                  <div class="card-body text-center">
                    <h4>${batches.filter(b => b.status === 'NS').length}</h4>
                    <small>Pendientes (NS)</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <h6 class="fw-bold mb-3">üë• M√©tricas por Segmentador</h6>
        <div class="row">
      `;

      // Generar m√©tricas por cada responsable
      Object.keys(byAssignee).sort().forEach(assignee => {
        const stats = byAssignee[assignee];
        const completionRate = ((stats.completed / stats.total) * 100).toFixed(1);
        const progressRate = ((stats.inProgress / stats.total) * 100).toFixed(1);
        
        metricsHtml += `
          <div class="col-md-6 mb-3">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-user"></i> ${assignee}
                  <span class="badge bg-primary ms-2">${stats.total} batches</span>
                </h6>
              </div>
              <div class="card-body">
                <div class="row text-center">
                  <div class="col-3">
                    <div class="text-success">
                      <h5>${stats.completed}</h5>
                      <small>Completados</small>
                      <br><small class="text-muted">${completionRate}%</small>
                    </div>
                  </div>
                  <div class="col-3">
                    <div class="text-warning">
                      <h5>${stats.inProgress}</h5>
                      <small>En Progreso</small>
                      <br><small class="text-muted">${progressRate}%</small>
                    </div>
                  </div>
                  <div class="col-3">
                    <div class="text-secondary">
                      <h5>${stats.pending}</h5>
                      <small>Pendientes</small>
                      <br><small class="text-muted">${(100 - parseFloat(completionRate) - parseFloat(progressRate)).toFixed(1)}%</small>
                    </div>
                  </div>
                  <div class="col-3">
                    <a href="/dashboard/${assignee}" class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-eye"></i> Ver Dashboard
                    </a>
                  </div>
                </div>
                
                <!-- Barra de progreso -->
                <div class="progress mt-3" style="height: 20px;">
                  <div class="progress-bar bg-success" style="width: ${completionRate}%" title="Completados: ${completionRate}%"></div>
                  <div class="progress-bar bg-warning" style="width: ${progressRate}%" title="En Progreso: ${progressRate}%"></div>
                </div>
                <small class="text-muted mt-1 d-block">
                  Progreso: ${completionRate}% completado, ${progressRate}% en proceso
                </small>
                
                <!-- Lista de batches recientes -->
                <div class="mt-3">
                  <small class="fw-bold">Batches Recientes:</small>
                  <div class="mt-1">
        `;
        
        // Mostrar los √∫ltimos 3 batches del responsable
        const recentBatches = stats.batches.slice(-3);
        recentBatches.forEach(batch => {
          const statusColor = batch.status === 'S' ? 'success' : 
                             batch.status === 'FS' ? 'warning' : 'secondary';
          metricsHtml += `
            <span class="badge bg-${statusColor} me-1 mb-1">${batch.id} (${batch.status})</span>
          `;
        });
        
        metricsHtml += `
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      metricsHtml += `
        </div>
        
        <!-- Tabla resumen -->
        <div class="table-responsive mt-4">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Responsable</th>
                <th>Total</th>
                <th>Completados</th>
                <th>En Progreso</th>
                <th>Pendientes</th>
                <th>% Completado</th>
                <th>√öltimo Batch</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      Object.keys(byAssignee).sort().forEach(assignee => {
        const stats = byAssignee[assignee];
        const completionRate = ((stats.completed / stats.total) * 100).toFixed(1);
        const lastBatch = stats.batches[stats.batches.length - 1];
        
        metricsHtml += `
          <tr>
            <td><strong>${assignee}</strong></td>
            <td>${stats.total}</td>
            <td><span class="badge bg-success">${stats.completed}</span></td>
            <td><span class="badge bg-warning">${stats.inProgress}</span></td>
            <td><span class="badge bg-secondary">${stats.pending}</span></td>
            <td>${completionRate}%</td>
            <td>${lastBatch ? lastBatch.id : 'N/A'}</td>
          </tr>
        `;
      });
      
      metricsHtml += `
            </tbody>
          </table>
        </div>
      `;

      // Mostrar el modal
      $('#teamMetricsContent').html(metricsHtml);
      $('#teamMetricsModal').modal('show');
    }

    // Funci√≥n para exportar m√©tricas
    function exportMetrics() {
      // Calcular estad√≠sticas
      const byAssignee = {};
      batches.forEach(b => {
        if (!byAssignee[b.assignee]) {
          byAssignee[b.assignee] = { total: 0, pending: 0, inProgress: 0, completed: 0 };
        }
        byAssignee[b.assignee].total++;
        if (b.status === 'NS') byAssignee[b.assignee].pending++;
        else if (b.status === 'FS') byAssignee[b.assignee].inProgress++;
        else if (b.status === 'S') byAssignee[b.assignee].completed++;
      });

      // Crear CSV
      let csvContent = "Responsable,Total,Completados,En Progreso,Pendientes,Porcentaje Completado\\n";
      Object.keys(byAssignee).sort().forEach(assignee => {
        const stats = byAssignee[assignee];
        const completionRate = ((stats.completed / stats.total) * 100).toFixed(1);
        csvContent += `${assignee},${stats.total},${stats.completed},${stats.inProgress},${stats.pending},${completionRate}%\\n`;
      });

      // Descargar archivo
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `metricas_equipo_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      showNotification('M√©tricas exportadas exitosamente', 'success');
    }

    function addInlineEditEvents() {
      // Evento para cambio de estado de segmentaci√≥n
      $('.segmentation-status-select').off('change').on('change', function() {
        const batchId = $(this).data('batch-id');
        const newStatus = $(this).val();
        updateBatchField(batchId, 'status', newStatus, $(this));
      });
      
      // Evento para cambio de prioridad
      $('.priority-select').off('change').on('change', function() {
        const batchId = $(this).data('batch-id');
        const newPriority = $(this).val();
        updateBatchField(batchId, 'priority', newPriority, $(this));
      });
      
      // Evento para cambio de fecha de revisi√≥n
      $('.review-date-input').off('change').on('change', function() {
        const batchId = $(this).data('batch-id');
        const newReviewDate = $(this).val();
        updateBatchField(batchId, 'reviewed_at', newReviewDate, $(this));
      });
      
      // Evento para cambio de Batch ID
      $('.batch-id-input').off('blur').on('blur', function() {
        const oldBatchId = $(this).data('batch-id');
        const newBatchId = $(this).val().trim();
        
        if (newBatchId !== oldBatchId) {
          updateBatchId(oldBatchId, newBatchId, $(this));
        }
      });
      
      // Evento para cambio de comentarios (al perder el foco)
      $('.comments-input').off('blur').on('blur', function() {
        const batchId = $(this).data('batch-id');
        const newComments = $(this).val();
        updateBatchField(batchId, 'comments', newComments, $(this));
      });
    }

    function updateBatchField(batchId, field, value, element) {
      // Mostrar indicador de guardado
      const originalBg = element.css('background-color');
      element.css('background-color', '#fff3cd');
      
      const updateData = {};
      if (field === 'reviewed_at') {
        updateData.metadata = { reviewed_at: value };
      } else if (field === 'priority') {
        updateData.metadata = { priority: value };
      } else {
        updateData[field] = value;
      }
      
      $.ajax({
        url: `/api/batches/${batchId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(updateData),
        success: function(response) {
          // Mostrar √©xito
          element.css('background-color', '#d4edda');
          setTimeout(() => {
            element.css('background-color', originalBg);
          }, 1000);
          
          // Actualizar datos locales
          const batch = batches.find(b => b.id === batchId);
          if (batch) {
            if (field === 'reviewed_at') {
              batch.metadata.reviewed_at = value;
            } else if (field === 'priority') {
              batch.metadata.priority = value;
            } else {
              batch[field] = value;
            }
            updateStats();
          }
          
          console.log(`‚úÖ ${field} actualizado para ${batchId}: ${value}`);
          showNotification(`Campo ${field} actualizado exitosamente`, 'success');
        },
        error: function(xhr) {
          // Mostrar error
          element.css('background-color', '#f8d7da');
          setTimeout(() => {
            element.css('background-color', originalBg);
          }, 2000);
          
          const errorMsg = xhr.responseJSON?.error || 'Error desconocido';
          showNotification(`Error actualizando ${field}: ${errorMsg}`, 'error');
          console.error(`‚ùå Error actualizando ${field}:`, xhr);
        }
      });
    }
    
    function updateBatchId(oldId, newId, element) {
      // Validar que el nuevo ID no est√© vac√≠o
      if (!newId) {
        showNotification('El Batch ID no puede estar vac√≠o', 'warning');
        element.val(oldId); // Restaurar valor anterior
        return;
      }
      
      // Validar que el nuevo ID no exista ya
      if (batches.find(b => b.id === newId && b.id !== oldId)) {
        showNotification(`El Batch ID "${newId}" ya existe. Por favor usa otro ID.`, 'warning');
        element.val(oldId); // Restaurar valor anterior
        return;
      }
      
      // Mostrar indicador de guardado
      const originalBg = element.css('background-color');
      element.css('background-color', '#fff3cd');
      
      $.ajax({
        url: `/api/batches/${oldId}/change-id`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ new_id: newId }),
        success: function(response) {
          // Mostrar √©xito
          element.css('background-color', '#d4edda');
          setTimeout(() => {
            element.css('background-color', originalBg);
          }, 1000);
          
          // Actualizar datos locales
          const batch = batches.find(b => b.id === oldId);
          if (batch) {
            batch.id = newId;
          }
          
          // Actualizar el data-batch-id del elemento
          element.data('batch-id', newId);
          
          console.log(`‚úÖ Batch ID actualizado de ${oldId} a ${newId}`);
          showNotification(`Batch ID actualizado a "${newId}"`, 'success');
          
          // Recargar tabla para actualizar todas las referencias
          loadBatches();
        },
        error: function(xhr) {
          // Mostrar error
          element.css('background-color', '#f8d7da');
          setTimeout(() => {
            element.css('background-color', originalBg);
          }, 2000);
          
          // Restaurar valor anterior
          element.val(oldId);
          
          const errorMsg = xhr.responseJSON?.error || 'Error desconocido';
          showNotification(`Error actualizando Batch ID: ${errorMsg}`, 'error');
          console.error(`‚ùå Error actualizando Batch ID:`, xhr);
        }
      });
    }
  </script>
  <!-- Modal de Leyenda de Estatus -->
  <div class="modal fade" id="statusLegendModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-info-circle"></i> Leyenda de Estatus de Segmentaci√≥n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-12">
              <h6 class="fw-bold mb-3">Estatus de Segmentaci√≥n:</h6>
              <ul class="list-unstyled">
                <li class="mb-2">
                  <span class="badge bg-success me-2">S</span>
                  <strong>Segmentado:</strong> Batch completamente segmentado
                </li>
                <li class="mb-2">
                  <span class="badge bg-warning me-2">FS</span>
                  <strong>Falta Segmentar:</strong> Faltan algunas im√°genes por segmentar
                </li>
                <li class="mb-2">
                  <span class="badge bg-secondary me-2">NS</span>
                  <strong>No Segmentado:</strong> Batch sin iniciar segmentaci√≥n
                </li>
              </ul>
              
              <h6 class="fw-bold mb-3 mt-4">MongoDB:</h6>
              <ul class="list-unstyled">
                <li class="mb-2">
                  <i class="fas fa-check-circle text-success me-2"></i>
                  <strong>S√≠:</strong> Archivos subidos a MongoDB
                </li>
                <li class="mb-2">
                  <i class="fas fa-times-circle text-danger me-2"></i>
                  <strong>No:</strong> Sin archivos en MongoDB
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
