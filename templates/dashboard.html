<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Segmentación</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
    .btn-primary:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%); }
    .status-pendiente { background-color: #fff3cd; color: #856404; }
    .status-en-progreso { background-color: #d1ecf1; color: #0c5460; }
    .status-completado { background-color: #d4edda; color: #155724; }
    .priority-alta { color: #dc3545; font-weight: bold; }
    .priority-media { color: #fd7e14; }
    .priority-baja { color: #28a745; }
    
    .status-select, .due-date-input {
      transition: background-color 0.3s ease;
    }
    
    .status-select:focus, .due-date-input:focus {
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      border-color: #667eea;
    }
    
    .saving {
      background-color: #fff3cd !important;
    }
    
    .saved {
      background-color: #d4edda !important;
    }
    
    .error {
      background-color: #f8d7da !important;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">
        <i class="fas fa-tasks"></i> Dashboard de Segmentación
        {% if filter_assignee %}
        <small class="text-light"> - {{ filter_assignee }}</small>
        {% endif %}
      </span>
      <div class="d-flex">
        <a href="/" class="btn btn-outline-light me-2">
          <i class="fas fa-users"></i> Equipo
        </a>
        <a href="/masks" class="btn btn-outline-light me-2">
          <i class="fas fa-image"></i> Ver Máscaras
        </a>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newBatchModal">
          <i class="fas fa-plus"></i> Nuevo Batch
        </button>
        <button class="btn btn-info ms-2" onclick="syncBatchFiles()">
          <i class="fas fa-sync-alt"></i> Sincronizar Archivos
        </button>
        <button class="btn btn-warning ms-2" onclick="resetBatches()">
          <i class="fas fa-sync"></i> Recargar Datos
        </button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title text-primary">Total Batches</h5>
            <h2 id="totalBatches" class="text-primary">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title text-warning">Pendientes</h5>
            <h2 id="pendingBatches" class="text-warning">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title text-info">En Progreso</h5>
            <h2 id="inProgressBatches" class="text-info">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title text-success">Completados</h5>
            <h2 id="completedBatches" class="text-success">0</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- Batches Table -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-list"></i> Gestión de Batches - Carpetas de Segmentación</h5>
        <div class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#statusLegendModal">
            <i class="fas fa-info-circle"></i> Leyenda
          </button>
          <label class="me-2">Filtrar por responsable:</label>
          <select id="assigneeFilter" class="form-select form-select-sm" style="width: auto;">
            <option value="">Todos</option>
            {% for member in crew %}
            <option value="{{ member }}">{{ member }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> 
          <strong>Información:</strong> Cada batch representa una carpeta de imágenes que debe ser procesada para segmentación. 
          <br><strong>Carpeta:</strong> Nombre o ruta de la carpeta que contiene las imágenes a segmentar.
          <br><strong>Edición rápida:</strong> Cambia el estado y fecha límite directamente en la tabla - se guardan automáticamente.
        </div>
        <table id="batchesTable" class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Batch ID</th>
              <th>Responsable</th>
              <th>Cargado a Mongo</th>
              <th>Estatus Segmentación</th>
              <th>Fecha Asignación</th>
              <th>Fecha Revisión</th>
              <th>Prioridad</th>
              <th>Comentarios</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal para Nuevo Batch -->
  <div class="modal fade" id="newBatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Crear Nuevo Batch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="newBatchForm">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Responsable</label>
                  <select class="form-select" name="assignee" required>
                    <option value="">Seleccionar...</option>
                    {% for member in crew %}
                    <option value="{{ member }}">{{ member }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Carpeta de Imágenes</label>
                  <input type="text" class="form-control" name="folder" required>
                  <div class="form-text">
                    <i class="fas fa-info-circle"></i> 
                    Nombre de la carpeta que contiene las imágenes a segmentar
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Fecha Límite</label>
                  <input type="date" class="form-control" name="due_date">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Prioridad</label>
                  <select class="form-select" name="priority">
                    <option value="baja">Baja</option>
                    <option value="media" selected>Media</option>
                    <option value="alta">Alta</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Comentarios</label>
              <textarea class="form-control" name="comments" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning btn-sm me-auto" onclick="debugInfo()">
            <i class="fas fa-bug"></i> Debug Info
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="createBatch()">Crear Batch</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Editar Batch -->
  <div class="modal fade" id="editBatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Batch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editBatchForm">
            <input type="hidden" name="batch_id">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Responsable</label>
                  <select class="form-select" name="assignee">
                    {% for member in crew %}
                    <option value="{{ member }}">{{ member }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Carpeta de Imágenes</label>
                  <input type="text" class="form-control" name="folder">
                  <div class="form-text">
                    <i class="fas fa-folder"></i> 
                    Ruta o nombre de la carpeta con las imágenes a procesar
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Estado</label>
                  <select class="form-select" name="status">
                    <option value="pendiente">Pendiente</option>
                    <option value="en-progreso">En Progreso</option>
                    <option value="completado">Completado</option>
                  </select>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Fecha Límite</label>
                  <input type="date" class="form-control" name="due_date">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Prioridad</label>
                  <select class="form-select" name="priority">
                    <option value="baja">Baja</option>
                    <option value="media">Media</option>
                    <option value="alta">Alta</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Comentarios</label>
              <textarea class="form-control" name="comments" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="updateBatch()">Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script>
    let batchesTable;
    let batches = [];
    let filterAssignee = '{{ filter_assignee or "" }}';
    
    // Función para mostrar notificaciones
    function showNotification(message, type = 'info') {
      // Crear el contenedor de notificaciones si no existe
      if (!document.getElementById('notificationContainer')) {
        const container = document.createElement('div');
        container.id = 'notificationContainer';
        container.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
          max-width: 400px;
        `;
        document.body.appendChild(container);
      }
      
      // Crear la notificación
      const notification = document.createElement('div');
      const alertClass = type === 'success' ? 'alert-success' : 
                        type === 'error' ? 'alert-danger' : 
                        type === 'warning' ? 'alert-warning' : 'alert-info';
      
      notification.className = `alert ${alertClass} alert-dismissible fade show`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 
                           type === 'error' ? 'exclamation-circle' : 
                           type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // Agregar al contenedor
      document.getElementById('notificationContainer').appendChild(notification);
      
      // Auto-remover después de 5 segundos
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }

    $(document).ready(function() {
      // Inicializar batches desde JSON si es necesario
      initBatches();
      
      // Cargar datos
      loadBatches();
      
      // Inicializar DataTable
      batchesTable = $('#batchesTable').DataTable({
        responsive: true,
        pageLength: 25,
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        },
        columnDefs: [
          { orderable: false, targets: -1 }
        ]
      });

      // Filtro por responsable
      $('#assigneeFilter').on('change', function() {
        const selectedAssignee = this.value;
        batchesTable.column(1).search(selectedAssignee).draw();
      });

      // Aplicar filtro automático si se especifica en la URL
      if (filterAssignee) {
        $('#assigneeFilter').val(filterAssignee);
      }
    });

    function initBatches() {
      $.post('/api/init-batches')
        .done(function(response) {
          console.log('Batches inicializados:', response.message);
        })
        .fail(function(xhr) {
          console.error('Error inicializando batches:', xhr.responseJSON);
        });
    }

    function loadBatches() {
      console.log('🔄 Cargando batches...');
      $.get('/api/batches')
        .done(function(data) {
          console.log('✅ Batches cargados:', data.length);
          console.log('📊 Datos recibidos:', data);
          batches = data;
          updateStats();
          updateTable();
        })
        .fail(function(xhr) {
          console.error('❌ Error cargando batches:', xhr);
          alert('Error cargando batches: ' + (xhr.responseJSON?.error || 'Error desconocido'));
        });
    }

    function updateStats() {
      const total = batches.length;
      const pending = batches.filter(b => b.status === 'pendiente').length;
      const inProgress = batches.filter(b => b.status === 'en-progreso').length;
      const completed = batches.filter(b => b.status === 'completado').length;

      $('#totalBatches').text(total);
      $('#pendingBatches').text(pending);
      $('#inProgressBatches').text(inProgress);
      $('#completedBatches').text(completed);

      // Actualizar estadísticas por responsable
      const byAssignee = {};
      batches.forEach(b => {
        if (!byAssignee[b.assignee]) {
          byAssignee[b.assignee] = { total: 0, pending: 0, inProgress: 0, completed: 0 };
        }
        byAssignee[b.assignee].total++;
        if (b.status === 'pendiente') byAssignee[b.assignee].pending++;
        else if (b.status === 'en-progreso') byAssignee[b.assignee].inProgress++;
        else if (b.status === 'completado') byAssignee[b.assignee].completed++;
      });

      console.log('Estadísticas por responsable:', byAssignee);
    }

    function updateTable() {
      console.log('📋 Actualizando tabla con', batches.length, 'batches');
      batchesTable.clear();
      
      batches.forEach(function(batch, index) {
        console.log(`Procesando batch ${index + 1}:`, batch);
        const priorityClass = `priority-${batch.metadata.priority}`;
        
        // Estado de MongoDB (Cargado a Mongo)
        const mongoStatus = batch.mongo_uploaded ? 
          `<i class="fas fa-check-circle text-success" title="Sí"></i> Sí` : 
          `<i class="fas fa-times-circle text-danger" title="No"></i> No`;
        
        // Selector de estatus de segmentación
        const statusSelect = `
          <select class="form-select form-select-sm segmentation-status-select" data-batch-id="${batch.id}" style="min-width: 80px;">
            <option value="S" ${batch.status === 'S' ? 'selected' : ''}>S - Segmentado</option>
            <option value="FS" ${batch.status === 'FS' ? 'selected' : ''}>FS - Falta Segmentar</option>
            <option value="NS" ${batch.status === 'NS' ? 'selected' : ''}>NS - No Segmentado</option>
          </select>
        `;
        
        // Badge del estatus para mejor visualización
        let statusBadge = '';
        switch(batch.status) {
          case 'S':
            statusBadge = '<span class="badge bg-success">S</span>';
            break;
          case 'FS':
            statusBadge = '<span class="badge bg-warning">FS</span>';
            break;
          case 'NS':
            statusBadge = '<span class="badge bg-secondary">NS</span>';
            break;
        }
        
        // Input de fecha de revisión editable
        const reviewDateInput = `
          <input type="date" class="form-control form-control-sm review-date-input" 
                 data-batch-id="${batch.id}" 
                 value="${batch.metadata.reviewed_at || ''}" 
                 style="min-width: 130px;">
        `;
        
        // Campo de comentarios editable
        const commentsInput = `
          <textarea class="form-control form-control-sm comments-input" 
                    data-batch-id="${batch.id}" 
                    rows="2" 
                    style="min-width: 200px;">${batch.comments || ''}</textarea>
        `;
        
        const row = [
          batch.id,
          batch.assignee,
          mongoStatus,
          statusSelect,
          batch.metadata.assigned_at,
          reviewDateInput,
          `<span class="${priorityClass}">${batch.metadata.priority}</span>`,
          commentsInput,
          `
            <button class="btn btn-sm btn-outline-success" onclick="saveBatchChanges('${batch.id}')" title="Guardar cambios">
              <i class="fas fa-save"></i>
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="viewBatchDetails('${batch.id}')" title="Ver detalles">
              <i class="fas fa-eye"></i>
            </button>
          `
        ];
        
        batchesTable.row.add(row);
      });
      
      batchesTable.draw();
      
      // Aplicar filtro automático si se especifica
      if (filterAssignee) {
        batchesTable.column(1).search(filterAssignee).draw();
      }
      
      // Agregar eventos para cambios inline
      addInlineEditEvents();
      
      console.log('✅ Tabla actualizada');
    }

    function createBatch() {
      console.log('🆕 Iniciando creación de batch...');
      
      const form = document.getElementById('newBatchForm');
      if (!form) {
        console.error('❌ No se encontró el formulario newBatchForm');
        showNotification('Error: Formulario no encontrado', 'error');
        return;
      }
      
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      console.log('📋 Datos del formulario:', data);
      
      // Validar campos requeridos
      if (!data.assignee) {
        showNotification('Por favor selecciona un responsable', 'warning');
        return;
      }
      
      if (!data.folder) {
        showNotification('Por favor ingresa la carpeta de imágenes', 'warning');
        return;
      }
      
      // Generar un ID único para el batch
      const nextId = 'batch_' + (Math.max(...batches.map(b => parseInt(b.id.replace('batch_', '')))) + 1);
      console.log('🆔 ID generado:', nextId);
      
      // Estructurar los datos según el nuevo formato
      const batchData = {
        id: nextId,
        assignee: data.assignee,
        folder: data.folder || `/data/${nextId}`,
        tasks: ["segmentar", "subir_mascaras", "revisar"],
        metadata: {
          assigned_at: new Date().toISOString().split('T')[0], // Fecha actual
          due_date: data.due_date || '',
          priority: data.priority || 'media',
          reviewed_at: null
        },
        status: 'NS', // No segmentado por defecto
        mongo_uploaded: false, // No subido por defecto
        comments: data.comments || 'Batch creado desde dashboard'
      };
      
      console.log('📤 Enviando datos:', batchData);
      showNotification('Creando batch...', 'info');
      
      $.ajax({
        url: '/api/batches',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(batchData),
        success: function(response) {
          console.log('✅ Respuesta del servidor:', response);
          if (response.success) {
            $('#newBatchModal').modal('hide');
            document.getElementById('newBatchForm').reset();
            showNotification(`¡Batch ${response.batch.id} creado exitosamente!`, 'success');
            loadBatches(); // Recargar la tabla
          } else {
            console.error('❌ Error en respuesta:', response);
            showNotification('Error creando batch: ' + response.message, 'error');
          }
        },
        error: function(xhr, status, error) {
          console.error('❌ Error AJAX:', {xhr, status, error});
          console.error('❌ Respuesta del servidor:', xhr.responseText);
          const errorMsg = xhr.responseJSON?.error || xhr.responseText || 'Error desconocido';
          showNotification('Error creando batch: ' + errorMsg, 'error');
        }
      });
    }

    // Función de debug para mostrar información del sistema
    function debugInfo() {
      const debugData = {
        timestamp: new Date().toISOString(),
        total_batches: batches.length,
        form_data: {
          assignee: document.getElementById('assignee').value,
          folder: document.getElementById('folder').value,
          due_date: document.getElementById('due_date').value,
          priority: document.getElementById('priority').value,
          comments: document.getElementById('comments').value
        },
        browser_info: {
          userAgent: navigator.userAgent,
          language: navigator.language,
          cookieEnabled: navigator.cookieEnabled
        },
        page_state: {
          current_filter: $('#responsibleFilter').val(),
          total_displayed_rows: $('#batchesTable tbody tr').length
        },
        recent_console_logs: 'Revisa la consola del navegador (F12) para más detalles'
      };

      console.log('🐛 DEBUG INFO COMPLETA:', debugData);
      
      // Mostrar en un modal o alert
      const debugText = `DEBUG INFO (${new Date().toLocaleString()}):
      
📊 Total Batches: ${debugData.total_batches}
🎯 Filtro Actual: ${debugData.page_state.current_filter}
📝 Filas Mostradas: ${debugData.page_state.total_displayed_rows}

📋 DATOS DEL FORMULARIO:
- Responsable: "${debugData.form_data.assignee}"
- Carpeta: "${debugData.form_data.folder}"
- Fecha Límite: "${debugData.form_data.due_date}"
- Prioridad: "${debugData.form_data.priority}"
- Comentarios: "${debugData.form_data.comments}"

🌐 NAVEGADOR:
- ${debugData.browser_info.userAgent}
- Idioma: ${debugData.browser_info.language}
- Cookies: ${debugData.browser_info.cookieEnabled ? 'Habilitadas' : 'Deshabilitadas'}

💡 NOTA: Información completa disponible en la consola del navegador (presiona F12)`;

      alert(debugText);
      showNotification('Información de debug generada - revisa la consola (F12)', 'info');
    }

    function editBatch(batchId) {
      const batch = batches.find(b => b.id === batchId);
      if (!batch) return;
      
      const form = document.getElementById('editBatchForm');
      form.batch_id.value = batch.id;
      form.assignee.value = batch.assignee;
      form.folder.value = batch.folder || '';
      form.status.value = batch.status;
      form.due_date.value = batch.metadata.due_date;
      form.priority.value = batch.metadata.priority;
      form.comments.value = batch.comments || '';
      
      $('#editBatchModal').modal('show');
    }

    function updateBatch() {
      const formData = new FormData(document.getElementById('editBatchForm'));
      const data = Object.fromEntries(formData.entries());
      const batchId = data.batch_id;
      delete data.batch_id;
      
      $.ajax({
        url: `/api/batches/${batchId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
          $('#editBatchModal').modal('hide');
          loadBatches();
          alert('Batch actualizado exitosamente');
        },
        error: function(xhr) {
          alert('Error actualizando batch: ' + xhr.responseJSON.error);
        }
      });
    }
    
    // Función para guardar cambios de un batch
    function saveBatchChanges(batchId) {
      const batch = batches.find(b => b.id === batchId);
      if (!batch) return;
      
      // Obtener valores de los campos editables
      const segmentationStatus = $(`.segmentation-status-select[data-batch-id="${batchId}"]`).val();
      const reviewDate = $(`.review-date-input[data-batch-id="${batchId}"]`).val();
      const comments = $(`.comments-input[data-batch-id="${batchId}"]`).val();
      
      // Actualizar el objeto batch
      batch.status = segmentationStatus;
      batch.metadata.reviewed_at = reviewDate;
      batch.comments = comments;
      
      // Enviar actualización al servidor
      $.ajax({
        url: `/api/batches/${batchId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({
          status: segmentationStatus,
          metadata: batch.metadata,
          comments: comments
        }),
        success: function(response) {
          if (response.success) {
            showNotification('Batch actualizado exitosamente', 'success');
            // Actualizar estadísticas
            updateStatistics();
          } else {
            showNotification('Error actualizando batch: ' + response.message, 'error');
          }
        },
        error: function(xhr) {
          showNotification('Error actualizando batch: ' + (xhr.responseJSON?.error || 'Error desconocido'), 'error');
        }
      });
    }
    
    // Función para ver detalles de un batch
    function viewBatchDetails(batchId) {
      const batch = batches.find(b => b.id === batchId);
      if (!batch) return;
      
      const mongoStatusText = batch.mongo_uploaded ? 'Sí' : 'No';
      const statusText = {
        'S': 'Segmentado Completo',
        'FS': 'Falta Segmentar',
        'NS': 'No Segmentado'
      }[batch.status] || batch.status;
      
      const modalContent = `
        <div class="row">
          <div class="col-md-6">
            <h6>Información General</h6>
            <p><strong>ID:</strong> ${batch.id}</p>
            <p><strong>Responsable:</strong> ${batch.assignee}</p>
            <p><strong>Carpeta:</strong> ${batch.folder}</p>
            <p><strong>Prioridad:</strong> ${batch.metadata.priority}</p>
          </div>
          <div class="col-md-6">
            <h6>Estado y Fechas</h6>
            <p><strong>Cargado a MongoDB:</strong> ${mongoStatusText}</p>
            <p><strong>Estatus:</strong> ${statusText}</p>
            <p><strong>Fecha Asignación:</strong> ${batch.metadata.assigned_at || 'No asignada'}</p>
            <p><strong>Fecha Revisión:</strong> ${batch.metadata.reviewed_at || 'Pendiente'}</p>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <h6>Comentarios</h6>
            <p class="text-muted">${batch.comments || 'Sin comentarios'}</p>
          </div>
        </div>
      `;
      
      // Mostrar modal con información
      const modal = `
        <div class="modal fade" id="batchDetailsModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Detalles del Batch ${batchId}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                ${modalContent}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remover modal anterior si existe
      $('#batchDetailsModal').remove();
      
      // Agregar y mostrar modal
      $('body').append(modal);
      $('#batchDetailsModal').modal('show');
    }
    
    // Función para ver archivos de un batch
    function viewBatchFiles(batchId) {
      $.ajax({
        url: `/api/batch-files/${batchId}`,
        method: 'GET',
        success: function(response) {
          if (response.success) {
            const fileInfo = response.file_info;
            let modalContent = '';
            
            if (fileInfo.count > 0) {
              modalContent = `
                <p><strong>Archivos encontrados:</strong> ${fileInfo.count}</p>
                <p><strong>Última subida:</strong> ${new Date(fileInfo.latest_upload).toLocaleString('es-ES')}</p>
                <p><strong>Subido por:</strong> ${fileInfo.uploaded_by}</p>
                <p><strong>Tamaño total:</strong> ${(fileInfo.total_size / (1024*1024)).toFixed(2)} MB</p>
                <hr>
                <p><a href="/masks" target="_blank" class="btn btn-primary">Ver todos los archivos en MongoDB</a></p>
              `;
            } else {
              modalContent = `
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle"></i>
                  No se encontraron archivos para el batch <strong>${batchId}</strong> en MongoDB.
                </div>
                <p>Los archivos deben seguir el patrón: <code>masks_batch_${batchId.replace('batch-', '')}.tar.xz</code></p>
              `;
            }
            
            // Mostrar modal con información
            const modal = `
              <div class="modal fade" id="fileInfoModal" tabindex="-1">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Archivos del Batch ${batchId}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      ${modalContent}
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            // Remover modal anterior si existe
            $('#fileInfoModal').remove();
            
            // Agregar y mostrar modal
            $('body').append(modal);
            $('#fileInfoModal').modal('show');
            
          } else {
            showNotification('Error al obtener información de archivos: ' + response.message, 'error');
          }
        },
        error: function() {
          showNotification('Error al conectar con el servidor', 'error');
        }
      });
    }

    function deleteBatch(batchId) {
      if (!confirm('¿Estás seguro de que quieres eliminar este batch?')) return;
      
      $.ajax({
        url: `/api/batches/${batchId}`,
        method: 'DELETE',
        success: function(response) {
          loadBatches();
          alert('Batch eliminado exitosamente');
        },
        error: function(xhr) {
          alert('Error eliminando batch: ' + xhr.responseJSON.error);
        }
      });
    }
    
    // Función para sincronizar archivos entre batches y MongoDB
    function syncBatchFiles() {
      showNotification('Sincronizando archivos con MongoDB...', 'info');
      
      $.ajax({
        url: '/api/sync-batch-files',
        method: 'POST',
        success: function(response) {
          if (response.success) {
            showNotification(`Sincronización completa. ${response.batches_updated} batches actualizados.`, 'success');
            loadBatches(); // Recargar la tabla
          } else {
            showNotification('Error en la sincronización: ' + response.message, 'error');
          }
        },
        error: function() {
          showNotification('Error al conectar con el servidor para sincronización', 'error');
        }
      });
    }

    function resetBatches() {
      if (!confirm('¿Estás seguro de que quieres recargar todos los datos desde el archivo JSON? Esto sobrescribirá cualquier cambio no guardado.')) return;
      
      $.ajax({
        url: '/api/reset-batches',
        method: 'POST',
        success: function(response) {
          loadBatches();
          alert(response.message);
        },
        error: function(xhr) {
          alert('Error recargando datos: ' + xhr.responseJSON.error);
        }
      });
    }

    function addInlineEditEvents() {
      // Evento para cambio de estado
      $('.status-select').off('change').on('change', function() {
        const batchId = $(this).data('batch-id');
        const newStatus = $(this).val();
        
        updateBatchField(batchId, 'status', newStatus, $(this));
      });
      
      // Evento para cambio de fecha límite
      $('.due-date-input').off('change').on('change', function() {
        const batchId = $(this).data('batch-id');
        const newDueDate = $(this).val();
        
        updateBatchField(batchId, 'due_date', newDueDate, $(this));
      });
    }

    function updateBatchField(batchId, field, value, element) {
      // Mostrar indicador de guardado
      const originalBg = element.css('background-color');
      element.css('background-color', '#fff3cd');
      
      const updateData = {};
      updateData[field] = value;
      
      $.ajax({
        url: `/api/batches/${batchId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(updateData),
        success: function(response) {
          // Mostrar éxito
          element.css('background-color', '#d4edda');
          setTimeout(() => {
            element.css('background-color', originalBg);
          }, 1000);
          
          // Actualizar datos locales
          const batch = batches.find(b => b.id === batchId);
          if (batch) {
            if (field === 'due_date') {
              batch.metadata.due_date = value;
            } else {
              batch[field] = value;
            }
            updateStats();
          }
          
          console.log(`✅ ${field} actualizado para ${batchId}: ${value}`);
        },
        error: function(xhr) {
          // Mostrar error
          element.css('background-color', '#f8d7da');
          setTimeout(() => {
            element.css('background-color', originalBg);
          }, 2000);
          
          alert(`Error actualizando ${field}: ${xhr.responseJSON?.error || 'Error desconocido'}`);
          console.error(`❌ Error actualizando ${field}:`, xhr);
        }
      });
    }
  </script>
  <!-- Modal de Leyenda de Estatus -->
  <div class="modal fade" id="statusLegendModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-info-circle"></i> Leyenda de Estatus de Segmentación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-12">
              <h6 class="fw-bold mb-3">Estatus de Segmentación:</h6>
              <ul class="list-unstyled">
                <li class="mb-2">
                  <span class="badge bg-success me-2">S</span>
                  <strong>Segmentado:</strong> Batch completamente segmentado
                </li>
                <li class="mb-2">
                  <span class="badge bg-warning me-2">FS</span>
                  <strong>Falta Segmentar:</strong> Faltan algunas imágenes por segmentar
                </li>
                <li class="mb-2">
                  <span class="badge bg-secondary me-2">NS</span>
                  <strong>No Segmentado:</strong> Batch sin iniciar segmentación
                </li>
              </ul>
              
              <h6 class="fw-bold mb-3 mt-4">MongoDB:</h6>
              <ul class="list-unstyled">
                <li class="mb-2">
                  <i class="fas fa-check-circle text-success me-2"></i>
                  <strong>Sí:</strong> Archivos subidos a MongoDB
                </li>
                <li class="mb-2">
                  <i class="fas fa-times-circle text-danger me-2"></i>
                  <strong>No:</strong> Sin archivos en MongoDB
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
