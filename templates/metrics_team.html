{% extends "base.html" %}

{% block title %}Métricas del Equipo - Métricas{% endblock %}

{% block extra_css_libs %}
<link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block page_css %}
{% include 'theme_system.html' %}
<style>
    body {
      background: var(--background);
      min-height: 100vh;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--text-primary);
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      transition: transform 0.2s ease;
      background: var(--surface);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .navbar {
      background: var(--surface) !important;
      border: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-bottom: 1px solid var(--border);
    }

    .btn-primary {
      background: var(--primary);
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      background: var(--primary-light);
    }

    .btn-outline-light {
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      border-radius: 20px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-outline-light:hover {
      background: rgba(255,255,255,0.2);
      border-color: white;
      color: white;
      transform: translateY(-1px);
    }

    /* Título principal */
    .dashboard-title {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.1) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2rem 3rem;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .dashboard-title h1 {
      color: white;
      font-size: 3rem;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      letter-spacing: 2px;
    }

    .dashboard-title p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.2rem;
      margin: 0.5rem 0 0 0;
      font-weight: 300;
    }

    /* Asegurar que el contenido principal tenga el z-index correcto */
    .main-content {
      position: relative;
      z-index: 1;
    }

    /* Estilos para las tarjetas de estadísticas */
    .card-title {
      background: linear-gradient(135deg, #10B981, #34D399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 600;
    }

    /* Estilos para métricas */
    .metric-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.2);
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(16, 185, 129, 0.25);
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #059669;
      margin-bottom: 0.5rem;
    }

    .metric-label {
      font-size: 1rem;
      color: #6B7280;
      font-weight: 500;
    }

    .progress-bar {
      background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
      border-radius: 10px;
    }

    .table {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      overflow: hidden;
    }

    .table thead th {
      background: linear-gradient(135deg, rgba(183, 148, 246, 0.2) 0%, rgba(246, 135, 179, 0.2) 100%);
      border: none;
      color: #6B46C1;
      font-weight: 600;
      padding: 1rem;
    }

    .table tbody tr:hover {
      background: linear-gradient(135deg, rgba(183, 148, 246, 0.1) 0%, rgba(246, 135, 179, 0.1) 100%);
    }

    /* Animaciones */
    .fade-in {
      animation: fadeIn 0.6s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse {
      animation: pulse-animation 2s infinite;
    }

    @keyframes pulse-animation {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Estilos específicos para métricas del equipo */
    .team-member-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      transition: all 0.3s ease;
    }

    .team-member-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
    }

    .member-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #059669;
      margin-bottom: 0.5rem;
    }

    .member-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .stat-item {
      text-align: center;
      flex: 1;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      display: block;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #6B7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .member-progress {
      margin-bottom: 1rem;
    }

    .member-recent-batches {
      font-size: 0.85rem;
      color: #6B7280;
    }

    .batch-tag {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      margin: 0.1rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .batch-completed { background: rgba(16, 185, 129, 0.2); color: #065F46; }
    .batch-progress { background: rgba(245, 158, 11, 0.2); color: #92400E; }
    .batch-pending { background: rgba(107, 114, 128, 0.2); color: #374151; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Título Principal -->
    <div class="dashboard-title">
      <h1><i class="fas fa-users"></i> MÉTRICAS DEL EQUIPO</h1>
      <p>Rendimiento individual y colectivo de los segmentadores</p>
    </div>

    <!-- Resumen General del Equipo -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="metric-card text-center">
          <div class="metric-value" id="totalMembers">0</div>
          <div class="metric-label">Miembros del Equipo</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card text-center">
          <div class="metric-value text-success" id="avgCompletionRate">0%</div>
          <div class="metric-label">Tasa Promedio de Completado</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card text-center">
          <div class="metric-value text-warning" id="totalActiveBatches">0</div>
          <div class="metric-label">Batches Activos</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="metric-card text-center">
          <div class="metric-value text-info" id="totalCompletedBatches">0</div>
          <div class="metric-label">Batches Completados</div>
        </div>
      </div>
    </div>


    <!-- Gráfica de Barras Horizontales - Completados por Persona -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Completados por Segmentador</h5>
      </div>
      <div class="card-body">
        <canvas id="completionChart" width="400" height="300"></canvas>
      </div>
    </div>

    <!-- Gráfica de Donut - Distribución de Estados -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Distribución General de Estados</h5>
      </div>
      <div class="card-body">
        <canvas id="statusDonutChart" width="400" height="300"></canvas>
      </div>
    </div>

    <!-- Tabla Comparativa -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-table"></i> Comparativa del Equipo</h5>
        <button type="button" class="btn btn-outline-light btn-sm" onclick="exportTeamMetrics()">
          <i class="fas fa-download"></i> Exportar
        </button>
      </div>
      <div class="card-body">
        <table id="teamTable" class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Segmentador</th>
              <th>Total Batches</th>
              <th>Completados</th>
              <th>En Progreso</th>
              <th>Pendientes</th>
              <th>% Completado</th>
              <th>Eficiencia</th>
            </tr>
          </thead>
          <tbody id="teamTableBody">
            <!-- Las filas se cargarán dinámicamente -->
          </tbody>
        </table>
      </div>
    </div>
</div>
{% endblock %}

{% block extra_js_libs %}
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
{% endblock %}

{% block page_js %}
<script>
    // Variables globales
    let teamMetrics = [];

    $(document).ready(function() {
      // Inicializar DataTables
      $('#teamTable').DataTable({
        pageLength: 25,
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        },
        order: [[5, 'desc']], // Ordenar por % completado descendente
        columnDefs: [
          { orderable: false, targets: -1 }
        ]
      });

      // Cargar datos
      loadBatches();
    });

    function loadBatches() {
      console.log('🔄 Cargando métricas del equipo...');
      $.get('/api/metrics/team')
        .done(function(response) {
          if (response.success) {
            teamMetrics = response.data;
            console.log('✅ Métricas del equipo cargadas:', teamMetrics.length);
            updateTeamMetricsFromAPI(teamMetrics);
          } else {
            console.error('❌ Error en respuesta:', response.error);
            alert('Error cargando métricas: ' + (response.error || 'Error desconocido'));
          }
        })
        .fail(function(xhr) {
          console.error('❌ Error cargando métricas del equipo:', xhr);
          alert('Error cargando métricas: ' + (xhr.responseJSON?.error || 'Error desconocido'));
        });
    }

    function updateTeamMetricsFromAPI(teamMetrics) {
      // Calcular estadísticas generales desde los datos del API
      const totalMembers = teamMetrics.length;
      const totalCompleted = teamMetrics.reduce((sum, member) => sum + member.completed, 0);
      const totalActive = teamMetrics.reduce((sum, member) => sum + member.in_progress, 0);
      const avgCompletionRate = totalMembers > 0 ?
        (teamMetrics.reduce((sum, member) => sum + member.completion_rate, 0) / totalMembers).toFixed(1) : 0;

      $('#totalMembers').text(totalMembers);
      $('#avgCompletionRate').text(avgCompletionRate + '%');
      $('#totalActiveBatches').text(totalActive);
      $('#totalCompletedBatches').text(totalCompleted);

      // Crear gráficas usando datos del API
      createCompletionChart(teamMetrics);
      createStatusDonutChart(teamMetrics);

      // Actualizar tabla usando datos del API
      updateTeamTableFromAPI(teamMetrics);
    }

    function createCompletionChart(teamMetrics) {
      const ctx = document.getElementById('completionChart').getContext('2d');

      // Ordenar por completados descendente
      const sortedData = teamMetrics.sort((a, b) => b.completed - a.completed);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedData.map(member => member.assignee),
          datasets: [{
            label: 'Batches Completados',
            data: sortedData.map(member => member.completed),
            backgroundColor: 'rgba(16, 185, 129, 0.8)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y', // Barras horizontales
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Batches Completados por Segmentador'
            }
          },
          scales: {
            x: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function createStatusDonutChart(teamMetrics) {
      const ctx = document.getElementById('statusDonutChart').getContext('2d');

      // Sumar todos los estados
      const totalCompleted = teamMetrics.reduce((sum, member) => sum + member.completed, 0);
      const totalInProgress = teamMetrics.reduce((sum, member) => sum + member.in_progress, 0);
      const totalPending = teamMetrics.reduce((sum, member) => sum + member.pending, 0);

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Completados', 'En Progreso', 'Pendientes'],
          datasets: [{
            data: [totalCompleted, totalInProgress, totalPending],
            backgroundColor: [
              'rgba(16, 185, 129, 0.8)',
              'rgba(245, 158, 11, 0.8)',
              'rgba(107, 114, 128, 0.8)'
            ],
            borderColor: [
              'rgba(16, 185, 129, 1)',
              'rgba(245, 158, 11, 1)',
              'rgba(107, 114, 128, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
            },
            title: {
              display: true,
              text: 'Distribución General de Estados'
            }
          }
        }
      });
    }


    function updateTeamTableFromAPI(teamMetrics) {
      const tableBody = document.getElementById('teamTableBody');
      tableBody.innerHTML = '';

      teamMetrics.forEach(member => {
        // Calcular eficiencia (completados / (completados + en progreso))
        const activeWork = member.completed + member.in_progress;
        const efficiency = activeWork > 0 ? ((member.completed / activeWork) * 100).toFixed(1) : 0;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${member.assignee}</strong></td>
          <td>${member.total}</td>
          <td><span class="badge bg-success">${member.completed}</span></td>
          <td><span class="badge bg-warning">${member.in_progress}</span></td>
          <td><span class="badge bg-secondary">${member.pending}</span></td>
          <td>${member.completion_rate}%</td>
          <td>${efficiency}%</td>
        `;
        tableBody.appendChild(row);
      });

      // Refrescar DataTable
      $('#teamTable').DataTable().draw();
    }

    function exportTeamMetrics() {
      // Usar datos del API
      const csvContent = "Segmentador,Total Batches,Completados,En Progreso,Pendientes,Porcentaje Completado,Eficiencia\\n" +
        teamMetrics.map(member => {
          const activeWork = member.completed + member.in_progress;
          const efficiency = activeWork > 0 ? ((member.completed / activeWork) * 100).toFixed(1) : 0;
          return `${member.assignee},${member.total},${member.completed},${member.in_progress},${member.pending},${member.completion_rate}%,${efficiency}%`;
        }).join("\\n");

      // Descargar archivo
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `metricas_equipo_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);

      showNotification('Métricas del equipo exportadas exitosamente', 'success');
    }

    function showNotification(message, type = 'info') {
      const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
      }[type] || 'alert-info';

      const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;

      $('body').append(alertHtml);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        $('.alert').fadeOut();
      }, 5000);
    }
</script>
{% endblock %}